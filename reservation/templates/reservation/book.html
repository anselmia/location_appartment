{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}
{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'reservation/css/book.css' %}">
    <link rel="stylesheet" href="{% static 'logement/css/image-galery.css' %}">
    <link rel="stylesheet" href="{% static 'logement/css/calendar.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
          rel="stylesheet" />
{% endblock %}
{% block content %}
    <div class="container reservation-container py-5">
        <div class="row justify-content-center">
            <!-- Left: Image Gallery -->
            <div class="col-12 mb-4">
                <div class="image-gallery enhanced-gallery">
                    {% if logement.photos.count > 0 %}
                        <!-- Main photo -->
                        <div class="gallery-left position-relative">
                            <picture>
                                <source srcset="{{ logement.photos.all.0.image_webp.url }}" type="image/webp">
                                <img src="{{ logement.photos.all.0.image_webp.url }}"
                                     alt="Photo principale"
                                     loading="lazy">
                            </picture>
                            <!-- Top-right logement stats -->
                            <div class="gallery-top-right-details">
                                <span title="Personnes"><i class="fas fa-user-friends"></i> {{ logement.max_traveler }} personnes</span>
                                <span title="Chambres"><i class="fas fa-door-open"></i> {{ logement.bedrooms }} chambres</span>
                                <span title="Lits"><i class="fas fa-bed"></i> {{ logement.beds }} lits</span>
                                <span title="Salles de bain"><i class="fas fa-bath"></i> {{ logement.bathrooms }} salles de bain</span>
                            </div>
                            <!-- Top-left info badge -->
                            <div class="gallery-badge-top">
                                <span><i class="fas fa-building"></i> {{ logement.get_type_display }}</span>
                                {% if logement.superficie %}<span><i class="fas fa-ruler-combined"></i> {{ logement.superficie }} m²</span>{% endif %}
                            </div>
                            <!-- Bottom-right icons -->
                            <div class="gallery-icons-overlay">
                                {% for equip in logement.equipment.all %}
                                    {% if equip.name in "Wifi Climatisation Cuisine Lave-linge Télévision Parking gratuit sur place" %}
                                        <i class="{{ equip.icon }}" title="{{ equip.name }}"></i>
                                    {% endif %}
                                {% endfor %}
                                {% if logement.animals %}
                                    <i class="fas fa-paw" title="Animaux acceptés"></i>
                                {% else %}
                                    <i class="fas fa-paw" style="opacity: 0.4" title="Animaux non autorisés"></i>
                                {% endif %}
                                {% if logement.smoking %}
                                    <i class="fas fa-smoking" title="Fumeurs autorisés"></i>
                                {% else %}
                                    <i class="fas fa-smoking-ban" title="Non fumeur"></i>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Small thumbnails -->
                        <div class="gallery-right">
                            {% for photo in logement.photos.all|slice:"1:5" %}
                                <div class="small-photo">
                                    <picture>
                                        <source srcset="{{ photo.image_webp.url }}" type="image/webp">
                                        <img src="{{ photo.image_webp.url }}"
                                             alt="Photo {{ forloop.counter }}"
                                             loading="lazy">
                                    </picture>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>Aucune photo disponible.</p>
                    {% endif %}
                </div>
            </div>
            <form method="post" id="reservation-form">
                {% csrf_token %}
                <div class="col-lg-6">
                    <div class="booking-box shadow-lg p-4 rounded">
                        <h2 class="section-title">{{ logement_data.name }}</h2>
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <ul>
                                    {% for field in form %}
                                        {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        <h4 class="mb-4 text-center">Informations sur le séjour</h4>
                        <div class="mb-3 row align-items-center justify-content-center">
                            <label for="id_guest" class="form-label me-2">Voyageurs :</label>
                            <div class="guest-input-wrapper">{{ form.guest|add_class:"form-control guest-input" }}</div>
                        </div>
                        <div class="calendar-box mt-4">
                            <div id="calendar_inline"></div>
                            <div class="legend">
                                <div class="legend-item">
                                    <span class="dot booked"></span> Réservé
                                </div>
                                <div class="legend-item">
                                    <span class="dot today"></span> Aujourd’hui
                                </div>
                                <div class="legend-item">
                                    <span class="dot free"></span> Disponible
                                </div>
                            </div>
                        </div>
                        {{ form.start.as_hidden }}
                        {{ form.end.as_hidden }}
                        <input type="hidden" name="reservation_id" value="{{ reservation.id }}">
                        <input type="hidden" name="reservation_code" value="{{ reservation.code }}">
                        <input type="hidden"
                               id="reservation-price"
                               name="reservation_price"
                               value="0">
                        <input type="hidden" id="reservation-tax" name="reservation_tax" value="0">
                    </div>
                    <div class="card logement-info-card mt-4 shadow-sm p-3">
                        <div class="card-body">
                            <h2 class="section-title">Détails du logement</h2>
                            <ul class="list-unstyled mb-0">
                                <li>
                                    <strong>Type :</strong> {{ logement_data.type_display }}
                                </li>
                                <li>
                                    <strong>Ville :</strong> {{ logement_data.ville.name }}
                                </li>
                                <li>
                                    <strong>Capacité :</strong> {{ logement_data.max_traveler }} voyageurs
                                </li>
                                <li>
                                    <strong>Chambres :</strong> {{ logement_data.bedrooms }}
                                </li>
                            </ul>
                            <section class="section-block caution-section">
                                <h2 class="section-title">Caution (remboursable)</h2>
                                <ul class="logement-list">
                                    <li>
                                        <strong>Montant :</strong> {{ logement_data.caution }} € / réservation
                                    </li>
                                    <li>
                                        <strong>Forme de paiement :</strong> Pré-autorisation sur carte bancaire
                                    </li>
                                </ul>
                            </section>
                            <section class="section-block cancellation-section">
                                <h2 class="section-title">Conditions d'annulation</h2>
                                <ul class="logement-list">
                                    <li>
                                        <strong>Avant {{ logement_data.cancelation_period }} jours :</strong>
                                        Annulation avec retenu des frais de paiement ({{ payment_fee }} %).
                                    </li>
                                    <li>
                                        <strong>À partir de {{ logement_data.cancelation_period }} jours avant l’entrée :</strong>
                                        L'annulation est non remboursable.
                                    </li>
                                </ul>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Booking Summary Right -->
                <div class="col-lg-6">
                    <div class="summary-box shadow-lg p-4 rounded">
                        <h4 class="section-title">Récapitulatif</h4>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Arrivée :</span>
                                <span class="fw-semibold" id="start-date">{{ form.start.value }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Départ :</span>
                                <span class="fw-semibold" id="end-date">{{ form.end.value }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Voyageurs :</span>
                                <span class="fw-semibold" id="guest-count">{{ form.guest.value }}</span>
                            </div>
                        </div>
                        <div class="pricing-summary my-3">
                            <div id="details"></div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="text-muted">Prix Total :</span>
                                <h5 class="fw-bold mb-0">
                                    <strong id="final-price">0</strong> €
                                </h5>
                            </div>
                        </div>
                        <hr>
                        <h5 class="mb-3">Vos informations</h5>
                        <ul class="list-unstyled mb-3">
                            <li>
                                <strong>Nom :</strong> {{ user.last_name }}
                            </li>
                            <li>
                                <strong>Prénom :</strong> {{ user.name }}
                            </li>
                            <li>
                                <strong>Email :</strong> {{ user.email }}
                            </li>
                            <li>
                                <strong>Téléphone :</strong> {{ user.phone }}
                            </li>
                        </ul>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" value="" id="cgv-check">
                            <label class="form-check-label" for="cgv-check">
                                J’ai lu et j’accepte les
                                <a href="{% url 'common:cgv' %}" target="_blank">Conditions Générales de Vente</a>
                                et la
                                <a href="{% url 'common:confidentiality' %}" target="_blank">Politique sur la protection des données</a>
                            </label>
                        </div>
                        <div class="text-center mt-4">
                            <button id="submit-booking" type="submit" class="btn-lg px-5" disabled>Procéder au Paiement</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="imageModal" class="image-modal">
        <span id="closeModal" class="close-btn">&times;</span>
        <span id="modalPrev" class="modal-arrow modal-arrow-left">&#10094;</span>
        <img id="modalImage" class="modal-content" src="">
        <span id="modalNext" class="modal-arrow modal-arrow-right">&#10095;</span>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
        // Defining all required JS variables before script loading
        const logement_js = {{ logement_data|safe }};
        const logementId = {{ logement.id }};  
        const csrfToken = "{{ csrf_token }}";
        const stripe_public_key = "{{ STRIPE_PUBLIC_KEY|escapejs }}";
        const reservedDatesStart = {{ reserved_dates_start_json|safe }};
        const reservedDatesEnd = {{ reserved_dates_end_json|safe }};
        const today = new Date().toISOString().slice(0, 10);
        const allPhotoUrls = {{ photo_urls|safe }};
        const periodLimit = {{ logement.availablity_period }};
    </script>
    <!-- External JS files -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="{% static 'logement/js/image-galery.js' %}"></script>
    <script src="{% static 'reservation/js/booking.js' %}"></script>
    <script src="{% static 'logement/js/calendar.js' %}"></script>
{% endblock %}
