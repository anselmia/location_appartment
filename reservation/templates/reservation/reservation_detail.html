{% extends 'base.html' %}
{% load static %}
{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet"
        href="{% static 'reservation/css/reservation_detail.css' %}" />
{% endblock extrahead %}
{% block content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center gap-3 ms-2">
        <a href="{% url 'reservation:reservation_dashboard' %}"
           class="btn btn-secondary btn-sm">
          <i class="bi bi-arrow-left"></i> Retour
        </a>
        <h2 class="fw-bold mb-0 ml-3 mb-sm-0">D√©tails de la R√©servation {{ reservation.code }}</h2>
      </div>
      {% if reservation.statut != "annulee" %}
        <form method="post"
              action="{% url 'reservation:cancel_reservation' reservation.code %}"
              onsubmit="return confirm('Confirmez-vous l‚Äôannulation d√©finitive de cette r√©servation ?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-x-circle"></i> Annuler
          </button>
        </form>
      {% endif %}
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row gy-4">
          <!-- Infos G√©n√©rales -->
          <div class="col-md-6">
            <h5 class="text-muted mb-3 border-bottom pb-1">Informations g√©n√©rales</h5>
            <dl class="row">
              <dt class="col-sm-5">Logement</dt>
              <dd class="col-sm-7">
                {{ reservation.logement.name }}
              </dd>
              <dt class="col-sm-5">Voyageur</dt>
              <dd class="col-sm-7">
                {{ reservation.user.name }} {{ reservation.user.last_name }}
              </dd>
              <dt class="col-sm-5">Stripe Customer ID</dt>
              <dd class="col-sm-7">
                {{ reservation.user.stripe_customer_id }}
              </dd>
              <dt class="col-sm-5">Arriv√©e</dt>
              <dd class="col-sm-7">
                {{ reservation.start|date:"d M Y" }}
              </dd>
              <dt class="col-sm-5">D√©part</dt>
              <dd class="col-sm-7">
                {{ reservation.end|date:"d M Y" }}
              </dd>
              <dt class="col-sm-5">Date de r√©servation</dt>
              <dd class="col-sm-7">
                {{ reservation.date_reservation|date:"d M Y H:i" }}
              </dd>
              <dt class="col-sm-5">Nombre d‚Äôinvit√©s</dt>
              <dd class="col-sm-7">
                Adulte(s){{ reservation.guest_adult }}
              </dd>
              <dd class="col-sm-7">
                Enfant(s){{ reservation.guest_minor }}
              </dd>
            </dl>
          </div>
          <!-- √âtat -->
          <div class="col-md-6">
            <h5 class="text-muted mb-3 border-bottom pb-1">√âtat de la r√©servation</h5>
            <dl class="row">
              <dt class="col-sm-5">Statut</dt>
              <dd class="col-sm-7">
                <span class="badge-status {{ reservation.statut|default:'inconnu' }}">{{ reservation.get_statut_display }}</span>
              </dd>
              <dt class="col-sm-5">√âtat actuel</dt>
              <dd class="col-sm-7">
                {% if reservation.ongoing %}
                  <span class="badge-status en-cours">En cours</span>
                {% elif reservation.ended %}
                  <span class="badge-status terminee">Termin√©e</span>
                {% elif reservation.coming %}
                  <span class="badge-status a-venir">√Ä venir</span>
                {% else %}
                  <span class="badge-status inconnu">Inconnu</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <!-- Paiement -->
          <div class="col-md-6">
            <h5 class="text-muted mb-3 border-bottom pb-1">Paiement</h5>
            <dl class="row">
              <dt class="col-sm-5">Prix</dt>
              <dd class="col-sm-7">
                {{ reservation.price|floatformat:2 }} ‚Ç¨
              </dd>
              <dt class="col-sm-5">Taxes</dt>
              <dd class="col-sm-7">
                {{ reservation.tax|floatformat:2 }} ‚Ç¨
              </dd>
              {% if reservation.statut == "echec_paiement" %}
                <dt class="col-sm-5 align-self-center">Paiement √©chou√©</dt>
                <dd class="col-sm-7">
                  <form method="post"
                        action="{% url 'payment:send_payment_link' reservation.code %}"
                        onsubmit="return confirm('CEnvoyer un nouveau lien de paiement au client ?');"
                        class="d-flex align-items-center">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">üîÅ Envoyer lien de paiement</button>
                  </form>
                </dd>
              {% else %}
                <dt class="col-sm-5">PaymentIntent</dt>
                <dd class="col-sm-7">
                  {{ reservation.stripe_payment_intent_id|default:"‚Äî" }}
                </dd>
                <dt class="col-sm-5">M√©thode Stripe</dt>
                <dd class="col-sm-7">
                  {{ reservation.stripe_saved_payment_method_id|default:"‚Äî" }}
                </dd>
                <dt class="col-sm-5">Rembours√©e ?</dt>
                <dd class="col-sm-7">
                  {% if reservation.refunded %}
                    <span class="badge bg-success">Oui</span>
                  {% else %}
                    <span class="badge bg-secondary">Non</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-5">Frais de Transaction (Non Remboursable)</dt>
                <dd class="col-sm-7">
                  {{ reservation.payment_fee|floatformat:2 }} ‚Ç¨
                </dd>
                <dt class="col-sm-5 d-flex align-items-center">
                  Frais Plateforme
                  <i class="ml-2 text-muted fas fa-info-circle"
                     data-toggle="tooltip"
                     data-placement="top"
                     title="Ces frais peuvent √™tre rembours√©s si la r√©servation est rembours√©e int√©gralement. Ils ne sont pas rembours√©s lors d'un remboursement partiel.">
                  </i>
                </dt>
                <dd class="col-sm-7">
                  {{ reservation.platform_fee|floatformat:2|default:"‚Äî" }} ‚Ç¨
                </dd>
                {% if not reservation.refunded %}
                  <dt class="col-sm-5">Montant Remboursable</dt>
                  <dd class="col-sm-7">
                    {{ reservation.refundable_amount|floatformat:2|default:"‚Äî" }} ‚Ç¨
                  </dd>
                  <dt class="col-sm-5 align-self-center">Remboursement total</dt>
                  <dd class="col-sm-7">
                    <form method="post"
                          action="{% url 'payment:refund_reservation' reservation.code %}"
                          onsubmit="return confirm('Confirmez-vous le remboursement int√©gral de cette r√©servation ?');"
                          class="d-flex align-items-center">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-warning">Remboursement complet</button>
                    </form>
                  </dd>
                  <dt class="col-sm-5 align-self-center">Remboursement partiel</dt>
                  <dd class="col-sm-7">
                    <form method="post"
                          action="{% url 'payment:refund_partially_reservation' reservation.code %}"
                          onsubmit="return confirm('Confirmez-vous le remboursement partiel de cette r√©servation ?');"
                          class="d-flex align-items-center">
                      {% csrf_token %}
                      <input type="number"
                             name="refund_amount"
                             class="form-control"
                             min="0"
                             max="{{ reservation.partial_refundable_amount|stringformat:'f' }}"
                             step="0.01"
                             placeholder="Montant (‚Ç¨)"
                             required
                             style="max-width: 200px" />
                      <button type="submit" class="btn btn-outline-warning">Rembourser</button>
                    </form>
                  </dd>
                {% else %}
                  <dt class="col-sm-5">Montant rembours√©</dt>
                  <dd class="col-sm-7">
                    {{ reservation.refund_amount|floatformat:2 }} ‚Ç¨
                  </dd>
                  <dt class="col-sm-5">Remboursement Stripe</dt>
                  <dd class="col-sm-7">
                    {{ reservation.stripe_refund_id|default:"‚Äî" }}
                  </dd>
                {% endif %}
              {% endif %}
            </dl>
          </div>
          <!-- Caution -->
          <div class="col-md-6">
            <h5 class="text-muted mb-3 border-bottom pb-1">Caution</h5>
            <dl class="row align-items-center">
              <dt class="col-sm-5">Caution</dt>
              <dd class="col-sm-7">
                {{ reservation.logement.caution|floatformat:2 }} ‚Ç¨
              </dd>
              <dt class="col-sm-5">Caution charg√©e ?</dt>
              <dd class="col-sm-7">
                {% if reservation.caution_charged %}
                  <span class="badge bg-success">Oui</span>
                {% else %}
                  <span class="badge bg-secondary">Non</span>
                {% endif %}
              </dd>
              {% if reservation.caution_charged %}
                <dt class="col-sm-5">Montant charg√©</dt>
                <dd class="col-sm-7">
                  {% if reservation.amount_charged %}
                    {{ reservation.amount_charged|floatformat:2 }} ‚Ç¨
                  {% else %}
                    ‚Äî
                  {% endif %}
                </dd>
                <dt class="col-sm-5">PaymentIntent caution</dt>
                <dd class="col-sm-7">
                  {{ reservation.stripe_deposit_payment_intent_id|default:"‚Äî" }}
                </dd>
              {% else %}
                <dt class="col-sm-5">Charger une caution</dt>
                <dd class="col-sm-7">
                  <form method="post"
                        action="{% url 'payment:charge_deposit' reservation.code %}"
                        onsubmit="return confirm('Confirmez-vous le pr√©l√®vement de cette caution ?');"
                        class="d-flex align-items-center">
                    {% csrf_token %}
                    <input type="number"
                           name="deposit_amount"
                           class="form-control form-control-sm me-2"
                           min="0"
                           max="{{ reservation.chargeable_deposit|stringformat:'f' }}"
                           step="0.01"
                           placeholder="Montant (‚Ç¨)"
                           required
                           style="max-width: 120px" />
                    <button type="submit" class="btn btn-sm btn-primary">Charger</button>
                  </form>
                </dd>
              {% endif %}
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });
  </script>
{% endblock extra_js %}
