{% extends "base.html" %}
{% load static %}
{% block title %}Gestion des R√©servations d'Activit√© | {{ entreprise.name }}{% endblock %}
{% block meta_description %}
    G√©rez les r√©servations d'activit√© sur {{ entreprise.name }} : consultez, validez, remboursez et transf√©rez les r√©servations d'activit√©.
{% endblock %}
{% block extrahead %}
    <link rel="stylesheet"
          href="{% static 'reservation/css/manage_reservations.css' %}">
{% endblock extrahead %}
{% block content %}
    <div class="container py-4">
        <h1 class="mb-4 fw-bold">üìã Gestion des R√©servations d'Activit√©</h1>
        <!-- Search Bar -->
        <form method="get" class="mb-4">
            <input type="text"
                   name="q"
                   class="form-control form-control-lg rounded-pill"
                   placeholder="üîç Rechercher par num√©ro de r√©servation ou activit√©"
                   value="{{ query|default:'' }}">
        </form>
        <div class="accordion" id="activityReservationAccordion">
            {% for r in reservations %}
                {% with collapse_id="collapse"|add:r.code %}
                    <div class="accordion-item mb-3 shadow-sm">
                        <h2 class="accordion-header" id="heading{{ r.code }}">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#{{ collapse_id }}"
                                    aria-expanded="false"
                                    aria-controls="{{ collapse_id }}">
                                <div class="me-3">
                                    <strong>{{ r.code }}</strong> - {{ r.activity.name }}
                                    <br>
                                    <span class="text-muted small">{{ r.user }}</span>
                                </div>
                                <span class="badge-status {{ r.statut|default:'inconnu' }}">{{ r.get_statut_display }}</span>
                            </button>
                        </h2>
                        <div id="{{ collapse_id }}"
                             class="accordion-collapse collapse"
                             aria-labelledby="heading{{ r.code }}"
                             data-bs-parent="#activityReservationAccordion">
                            <div class="accordion-body">
                                <div class="row mb-3 small">
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <strong>Client :</strong> {{ r.user }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Activit√© :</strong> {{ r.activity.name }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Date :</strong> du {{ r.start|date:"d M Y H:i" }} au {{ r.end|date:"d M Y H:i" }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Participants :</strong> {{ r.participants }}
                                        </p>
                                        <p class="mb-1 text-muted">R√©serv√© le {{ r.date_reservation|date:"d M Y H:i" }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <strong>Statut actuel :</strong>
                                            {% if r.ongoing %}
                                                <span class="badge-status en-cours">En cours</span>
                                            {% elif r.ended %}
                                                <span class="badge-status terminee">Termin√©e</span>
                                            {% elif r.coming %}
                                                <span class="badge-status a-venir">√Ä venir</span>
                                            {% elif r.pending or r.statut == 'en_attente' %}
                                                <span class="badge-status en_attente">En attente</span>
                                                <form method="post"
                                                      action="{% url 'reservation:validate_activity_reservation' r.code %}"
                                                      class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-success btn-sm">Valider</button>
                                                </form>
                                            {% else %}
                                                <span class="badge-status inconnu">Inconnu</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <hr class="my-3">
                                <div class="row g-4 small">
                                    <!-- Paiement -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted fw-bold mb-2">Paiement</h6>
                                        <ul class="list-unstyled mb-2">
                                            <li>
                                                <strong>Montant :</strong> {{ r.checkout_amount|default:"0.00"|floatformat:2 }} ‚Ç¨
                                                {% if r.paid %}
                                                    <span class="badge bg-success ms-2">Confirm√©</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark ms-2">Non confirm√©</span>
                                                {% endif %}
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <strong class="me-2">Pay√©e :</strong>
                                                <form method="post"
                                                      action="{% url 'reservation:toggle_paid' r.code %}"
                                                      class="d-inline-block m-0 p-0">
                                                    {% csrf_token %}
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               name="paid"
                                                               id="paidSwitch{{ r.code }}"
                                                               {% if r.paid %}checked{% endif %}
                                                               onchange="this.form.submit()">
                                                        <label class="form-check-label" for="paidSwitch{{ r.code }}">
                                                            {% if r.paid %}
                                                                <span class="text-success">Oui</span>
                                                            {% else %}
                                                                <span class="text-danger">Non</span>
                                                            {% endif %}
                                                        </label>
                                                    </div>
                                                </form>
                                            </li>
                                            <li>
                                                <strong>Frais paiement :</strong> {{ r.payment_fee|default:0|floatformat:2 }} ‚Ç¨
                                            </li>
                                            <li>
                                                <strong>Frais plateforme :</strong> {{ r.platform_fee|default:0|floatformat:2 }} ‚Ç¨
                                            </li>
                                            <li>
                                                <strong>ID M√©thode de paiement :</strong> {{ r.stripe_saved_payment_method_id|default:"--" }}
                                            </li>
                                            <li>
                                                <strong>ID Intent :</strong> {{ r.stripe_payment_intent_id|default:"--" }}
                                            </li>
                                        </ul>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% if r.can_verify_payment_failed %}
                                                <form method="post" action="{% url 'payment:verify_payment' r.code %}">
                                                    {% csrf_token %}
                                                    <button type="submit"
                                                            class="btn btn-outline-primary btn-sm"
                                                            title="V√©rifier le paiement Stripe">
                                                        <i class="bi bi-shield-check"></i> V√©rifier Paiement
                                                    </button>
                                                </form>
                                            {% endif %}
                                            {% if r.payment_failed %}
                                                <form method="post"
                                                      action="{% url 'payment:send_payment_link' r.code %}"
                                                      onsubmit="return confirm('Envoyer un nouveau lien de paiement au client ?');">
                                                    {% csrf_token %}
                                                    <button type="submit"
                                                            class="btn btn-outline-warning btn-sm"
                                                            title="Envoyer un lien de paiement au client">
                                                        <i class="bi bi-link-45deg"></i> Envoyer lien
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <!-- Remboursement -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted fw-bold mb-2">Remboursement</h6>
                                        <ul class="list-unstyled mb-2">
                                            {% if r.refunded %}
                                                <li class="text-success">
                                                    <strong>Rembours√© :</strong> {{ r.refund_amount|floatformat:2 }} ‚Ç¨
                                                </li>
                                            {% else %}
                                                <li class="text-muted">
                                                    <strong>Montant remboursable :</strong> {{ r.refundable_amount|default:"0.00"|floatformat:2 }} ‚Ç¨
                                                </li>
                                            {% endif %}
                                            <li>
                                                {% if r.paid and not r.refunded and r.refundable_amount > 0 %}
                                                    <form method="post"
                                                          action="{% url 'payment:refund_reservation' reservation.code %}"
                                                          onsubmit="return confirm('Confirmez-vous le remboursement int√©gral de cette r√©servation ?');"
                                                          class="d-flex align-items-center">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-warning">Remboursement complet</button>
                                                    </form>
                                                    <form method="post"
                                                          action="{% url 'payment:refund_partially_reservation' reservation.code %}"
                                                          onsubmit="return confirm('Confirmez-vous le remboursement partiel de cette r√©servation ?');"
                                                          class="d-flex align-items-center">
                                                        {% csrf_token %}
                                                        <input type="number"
                                                               name="refund_amount"
                                                               class="form-control"
                                                               min="0"
                                                               max="{{ reservation.partial_refundable_amount|stringformat:'f' }}"
                                                               step="0.01"
                                                               placeholder="Montant (‚Ç¨)"
                                                               required
                                                               style="max-width: 200px" />
                                                        <button type="submit" class="btn btn-outline-warning">Rembourser</button>
                                                    </form>
                                                {% else %}
                                                    {% if not reservation.paid %}
                                                        <p class="text-muted fst-italic mb-0">
                                                            Aucun remboursement n√©cessaire pour cette r√©servation. Le paiement n'a pas encore √©t√© encaiss√©.
                                                        </p>
                                                    {% else %}
                                                        <p class="text-muted fst-italic mb-0">Aucun remboursement n'est possible pour cette r√©servation.</p>
                                                    {% endif %}
                                                {% endif %}
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- Transferts -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted fw-bold mb-2">Transferts</h6>
                                        {% if r.transferred %}
                                            <div>
                                                <span class="text-success">‚úîÔ∏è {{ r.transferred_amount|floatformat:2 }} ‚Ç¨</span>
                                                <br>
                                                <small class="text-muted">ID : {{ r.stripe_transfer_id }}</small>
                                                {% if not r.transferred_amount or r.transferred_amount == 0 %}
                                                    <form method="post"
                                                          action="{% url 'payment:verify_transfer' r.code %}"
                                                          class="d-inline-block ms-2">
                                                        {% csrf_token %}
                                                        <button type="submit"
                                                                class="btn btn-sm btn-outline-primary"
                                                                title="V√©rifier le transfert">
                                                            <i class="bi bi-arrow-repeat"></i> V√©rifier
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        {% elif r.paid and r.transferable_amount > 0 %}
                                            <div>
                                                <span>{{ r.transferable_amount|floatformat:2 }} ‚Ç¨ transf√©rable</span>
                                                <form method="post"
                                                      action="{% url 'payment:transfer_reservation' r.code %}"
                                                      class="d-inline-block ms-2"
                                                      onsubmit="return confirm('Effectuer le transfert ?');">
                                                    {% csrf_token %}
                                                    <button class="btn btn-sm btn-outline-success" title="Transf√©rer">
                                                        <i class="bi bi-arrow-right-circle"></i> Transf√©rer
                                                    </button>
                                                </form>
                                            </div>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucun transfert possible.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endwith %}
            {% empty %}
                <div class="alert alert-info">Aucune r√©servation d'activit√© trouv√©e.</div>
            {% endfor %}
        </div>
    </div>
{% endblock content %}
