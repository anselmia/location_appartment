{% extends "base.html" %}
{% load static %}
{% block title %}Gestion des R√©servations | {{ entreprise.name }}{% endblock %}
{% block meta_description %}
  G√©rez les r√©servations de logements sur {{ entreprise.name }} : consultez, modifiez et g√©rez les paiements et remboursements.
{% endblock %}
{% block extrahead %}
  <link rel="stylesheet"
        href="{% static 'reservation/css/manage_reservations.css' %}">
{% endblock extrahead %}
{% block content %}
  <div class="container py-4">
    <h1 class="mb-4 fw-bold">üìã Gestion des R√©servations</h1>
    <!-- Search Bar -->
    <form method="get" class="mb-4">
      <input type="text"
             name="q"
             class="form-control form-control-lg rounded-pill"
             placeholder="üîç Rechercher par num√©ro de r√©servation"
             value="{{ query|default:'' }}">
    </form>
    <div class="accordion" id="reservationAccordion">
      {% for r in reservations %}
        {% with collapse_id="collapse"|add:r.code %}
          <div class="accordion-item mb-3 shadow-sm">
            <h2 class="accordion-header" id="heading{{ r.code }}">
              <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#{{ collapse_id }}"
                      aria-expanded="false"
                      aria-controls="{{ collapse_id }}">
                <div class="me-3">
                  <strong>{{ r.code }}</strong> - {{ r.logement.name }}
                </div>
                <span class="badge-status {{ r.statut|default:'inconnu' }}">{{ r.get_statut_display }}</span>
              </button>
            </h2>
            <div id="{{ collapse_id }}"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading{{ r.code }}"
                 data-bs-parent="#reservationAccordion">
              <div class="accordion-body">
                <div class="row mb-3 small">
                  <div class="col-md-6">
                    <p class="mb-1">
                      <strong>Client :</strong> {{ r.user }}
                    </p>
                    <p class="mb-1">
                      <strong>S√©jour :</strong> du {{ r.start }} au {{ r.end }}
                    </p>
                    <p class="mb-1">
                      <strong>Voyageurs :</strong> {{ r.total_guest }}
                    </p>
                    <p class="mb-1 text-muted">R√©serv√© le {{ r.date_reservation|date:"d M Y H:i" }}</p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-1">
                      <strong>Statut actuel :</strong>
                      {% if r.ongoing %}
                        <span class="badge-status en-cours">En cours</span>
                      {% elif r.ended %}
                        <span class="badge-status terminee">Termin√©e</span>
                      {% elif r.coming %}
                        <span class="badge-status a-venir">A venir</span>
                      {% else %}
                        <span class="badge-status inconnu">Inconnu</span>
                      {% endif %}
                    </p>
                  </div>
                </div>
                <div class="row g-4 small">
                  <!-- Paiement -->
                  <div class="col-md-4">
                    <h6 class="text-muted fw-bold mb-2">Paiement</h6>
                    <ul class="list-unstyled mb-2">
                      <li>
                        <strong>Montant :</strong> {{ r.checkout_amount|default:"0.00"|floatformat:2 }} ‚Ç¨
                        {% if r.paid %}
                          <span class="badge bg-success ms-2">Confirm√©</span>
                        {% else %}
                          <span class="badge bg-warning text-dark ms-2">Non confirm√©</span>
                        {% endif %}
                      </li>
                      <li>
                        <strong>Taxes :</strong> {{ r.tax|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>Frais paiement :</strong> {{ r.payment_fee|default:0|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>Frais plateforme :</strong> {{ r.platform_fee|default:0|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>ID M√©thode de paiement :</strong> {{ r.stripe_saved_payment_method_id|default:"--" }}
                      </li>
                      <li>
                        <strong>ID Intent :</strong> {{ r.stripe_payment_intent_id|default:"--" }}
                      </li>
                    </ul>
                    <div class="d-flex flex-wrap gap-2">
                      {% if r.can_verify_payment_failed %}
                        <form method="post" action="{% url 'payment:verify_payment' r.code %}">
                          {% csrf_token %}
                          <button type="submit"
                                  class="btn btn-outline-primary btn-sm"
                                  title="V√©rifier le paiement Stripe">
                            <i class="bi bi-shield-check"></i> V√©rifier Paiement
                          </button>
                        </form>
                      {% endif %}
                      {% if r.payment_failed %}
                        <form method="post"
                              action="{% url 'payment:send_payment_link' r.code %}"
                              onsubmit="return confirm('Envoyer un nouveau lien de paiement au client ?');">
                          {% csrf_token %}
                          <button type="submit"
                                  class="btn btn-outline-warning btn-sm"
                                  title="Envoyer un lien de paiement au client">
                            <i class="bi bi-link-45deg"></i> Envoyer lien
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                  <!-- Remboursement -->
                  <div class="col-md-4">
                    <h6 class="text-muted fw-bold mb-2">Remboursement</h6>
                    <ul class="list-unstyled mb-2">
                      <li>
                        <strong>Rembours√© :</strong> {{ r.refund_amount|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>Montant remboursable :</strong> {{ r.refundable_amount|default:"0.00"|floatformat:2 }} ‚Ç¨
                      </li>
                    </ul>
                    {% if r.paid and not r.refunded and r.refundable_amount > 0 %}
                      <form method="post"
                            action="{% url 'payment:refund_reservation' r.code %}"
                            class="d-flex gap-2 align-items-center"
                            onsubmit="return confirm('Confirmer le remboursement ?');">
                        {% csrf_token %}
                        <input type="number"
                               name="amount"
                               class="form-control form-control-sm"
                               min="0"
                               max="{{ r.refundable_amount|stringformat:'f' }}"
                               step="0.01"
                               placeholder="Montant">
                        <button type="submit"
                                class="btn btn-sm btn-outline-danger"
                                title="Rembourser">
                          <i class="bi bi-cash-coin"></i> Rembourser
                        </button>
                      </form>
                    {% else %}
                      <p class="text-muted mb-0">Aucun remboursement n'est possible pour cette r√©servation.</p>
                    {% endif %}
                  </div>
                  <!-- Transferts -->
                  <div class="col-md-4">
                    <h6 class="text-muted fw-bold mb-2">Transferts</h6>
                    {% if r.transferred %}
                      <div>
                        <span class="text-success">‚úîÔ∏è {{ r.transferred_amount|floatformat:2 }} ‚Ç¨</span>
                        <br>
                        <small class="text-muted">ID : {{ r.stripe_transfer_id }}</small>
                        {% if not r.transferred_amount or r.transferred_amount == 0 %}
                          <form method="post"
                                action="{% url 'payment:verify_transfer' r.code %}"
                                class="d-inline-block ms-2">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-sm btn-outline-primary"
                                    title="V√©rifier le transfert">
                              <i class="bi bi-arrow-repeat"></i> V√©rifier
                            </button>
                          </form>
                        {% endif %}
                      </div>
                    {% elif r.paid and r.transferable_amount > 0 %}
                      <div>
                        <span>{{ r.transferable_amount|floatformat:2 }} ‚Ç¨ transf√©rable</span>
                        <form method="post"
                              action="{% url 'payment:transfer_reservation' r.code %}"
                              class="d-inline-block ms-2"
                              onsubmit="return confirm('Effectuer le transfert ?');">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-success" title="Transf√©rer">
                            <i class="bi bi-arrow-right-circle"></i> Transf√©rer
                          </button>
                        </form>
                      </div>
                    {% else %}
                      <p class="text-muted mb-0">Aucun transfert possible.</p>
                    {% endif %}
                  </div>
                </div>
                <!-- Caution -->
                <div class="row mt-3 small">
                  <div class="col-md-6">
                    <h6 class="text-muted fw-bold">Caution</h6>
                    <ul class="list-unstyled">
                      <li>
                        <strong>Pr√©vue :</strong> {{ r.logement.caution|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>Charg√©e :</strong> {{ r.amount_charged|floatformat:2 }} ‚Ç¨
                      </li>
                      <li>
                        <strong>Restante :</strong> {{ r.chargeable_deposit|floatformat:2 }} ‚Ç¨
                      </li>
                    </ul>
                    {% if r.stripe_payment_intent_id and not r.caution_charged > 0 %}
                      <form method="post"
                            action="{% url 'payment:charge_deposit' r.code %}"
                            class="d-flex gap-2 align-items-center"
                            onsubmit="return confirm('Charger la caution restante ?');">
                        {% csrf_token %}
                        <input type="number"
                               name="deposit_amount"
                               class="form-control form-control-sm"
                               min="0"
                               max="{{ r.chargeable_deposit|stringformat:'f' }}"
                               step="0.01"
                               placeholder="Montant">
                        <button type="submit" class="btn btn-sm btn-primary">üí≥ Charger</button>
                      </form>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-muted fw-bold">Transferts</h6>
                    <p class="mb-1">
                      <strong>Propri√©taire :</strong>
                      {% if r.transferred %}
                        <span class="text-success">‚úîÔ∏è {{ r.transferred_amount|floatformat:2 }} ‚Ç¨</span>
                        <br>
                        <small class="text-muted">ID : {{ r.stripe_transfer_id }}</small>
                        {% if r.transferred_amount == 0 %}
                          <form method="post"
                                action="{% url 'payment:verify_transfer' r.code %}"
                                class="d-inline-block ms-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-primary">V√©rifier</button>
                          </form>
                        {% endif %}
                      {% elif r.paid %}
                        {{ r.transferable_amount|floatformat:2 }} ‚Ç¨
                        <form method="post"
                              action="{% url 'payment:transfer_reservation' r.code %}"
                              class="d-inline-block ms-2"
                              onsubmit="return confirm('Effectuer le transfert ?');">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-success">üí∂ Transf√©rer</button>
                        </form>
                      {% else %}
                        <p class="text-muted">Aucun transfert possible.</p>
                      {% endif %}
                    </p>
                    {% if r.logement.admin %}
                      <p class="mb-1">
                        <strong>Admin :</strong>
                        {% if r.admin_transferred %}
                          <span class="text-success">‚úîÔ∏è {{ r.admin_transferred_amount|floatformat:2 }} ‚Ç¨</span>
                          <br>
                          <small class="text-muted">ID : {{ r.admin_stripe_transfer_id }}</small>
                        {% else %}
                          {{ r.admin_transferable_amount|floatformat:2 }} ‚Ç¨
                        {% endif %}
                      </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endwith %}
      {% empty %}
        <p class="text-center text-muted mt-5">Aucune r√©servation trouv√©e.</p>
      {% endfor %}
    </div>
    <div class="d-flex justify-content-center mt-4">
      <nav aria-label="Pagination">
        <ul class="pagination-list">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a href="?q={{ query }}&page={{ page_obj.previous_page_number }}"
                 aria-label="Pr√©c√©dent">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span>&laquo;</span>
            </li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
              <a chref="?q={{ query }}&page={{ num }}">{{ num }}</a>
            </li>
          {% endfor %}
          {% if page_obj.has_next %}
            <li class="page-item">
              <a href="?q={{ query }}&page={{ page_obj.next_page_number }}"
                 aria-label="Suivant">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span>&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
{% endblock content %}
