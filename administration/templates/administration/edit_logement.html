{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block content %}
<div class="admin-logement-edit">
    <div class="form-box">
        <h2 class="text-center">{% trans "Modifier le logement" %} : {{ logement.name }}</h2>

        <!-- === Logement Edit Form === -->
        <form method="post" class="logement-form">
            <h3 class="form-title">üè° Ajouter un logement</h3>
            {% csrf_token %}

            {% if form.errors %}
                <div class="alert alert-danger mt-3">
                    <ul class="mb-0">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <div class="form-field">
                <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name|add_class:"form-input" }}
            </div>

            <div class="form-field">
                <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                {{ form.description|add_class:"form-textarea" }}
            </div>

            <div class="form-field with-symbol">
                <label for="{{ form.price.id_for_label }}">{{ form.price.label }}</label>
                <div class="input-symbol">
                    {{ form.price|add_class:"form-input" }}
                    <span>‚Ç¨</span>
                </div>
            </div>

            <div class="form-field">
                <label for="{{ form.max_traveler.id_for_label }}">{{ form.max_traveler.label }}</label>
                {{ form.max_traveler|add_class:"form-input" }}
            </div>

            <div class="form-field">
                <label for="{{ form.nominal_traveler.id_for_label }}">{{ form.nominal_traveler.label }}</label>
                {{ form.nominal_traveler|add_class:"form-input" }}
            </div>

            <div class="form-field">
                <label for="{{ form.bedrooms.id_for_label }}">{{ form.bedrooms.label }}</label>
                {{ form.bedrooms|add_class:"form-input" }}
            </div>

            <div class="form-field with-symbol">
                <label for="{{ form.fee_per_extra_traveler.id_for_label }}">{{ form.fee_per_extra_traveler.label }}</label>
                <div class="input-symbol">
                    {{ form.fee_per_extra_traveler|add_class:"form-input" }}
                    <span>‚Ç¨</span>
                </div>
            </div>

            <div class="form-field with-symbol">
                <label for="{{ form.cleaning_fee.id_for_label }}">{{ form.cleaning_fee.label }}</label>
                <div class="input-symbol">
                    {{ form.cleaning_fee|add_class:"form-input" }}
                    <span>‚Ç¨</span>
                </div>
            </div>

            <div class="form-field with-symbol">
                <label for="{{ form.tax.id_for_label }}">{{ form.tax.label }}</label>
                <div class="input-symbol">
                    {{ form.tax|add_class:"form-input" }}
                    <span>%</span>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-submit">üíæ Enregistrer</button>
            </div>
        </form>

        <!-- === Tabs === -->
        <ul class="nav nav-tabs" id="logementTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="rooms-tab" data-toggle="tab" href="#rooms" role="tab">üìÅ {% trans "Pi√®ces" %}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="photos-tab" data-toggle="tab" href="#photos" role="tab">üñºÔ∏è {% trans "Photos" %}</a>
            </li>
        </ul>

        <div class="tab-content" id="logementTabsContent">
            <!-- === Rooms Tab === -->
            <div class="tab-pane fade show active pt-4" id="rooms" role="tabpanel">
                <ul class="list-unstyled mb-3">
                    {% for room in rooms %}
                        <li class="d-flex justify-content-between align-items-center py-1">
                            <span>üè∑Ô∏è {{ room.name }}</span>
                            <form method="post" action="{% url 'administration:delete_room' room.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('{% trans 'Supprimer cette pi√®ce ?' %}')">üóëÔ∏è</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>

                <form method="post" action="{% url 'administration:add_room' logement.id %}" class="form-inline">
                    {% csrf_token %}
                    <input type="text" name="name" placeholder="{% trans 'Nom de la pi√®ce' %}" class="form-control mr-2" required>
                    <button type="submit" class="btn btn-success">‚ûï {% trans 'Ajouter' %}</button>
                </form>
            </div>

            <!-- === Photos Tab === -->
            <div class="tab-pane fade pt-4" id="photos" role="tabpanel">
                <div class="text-right mb-3">
                    <button id="delete-all-photos" class="btn btn-danger btn-sm">
                        üóëÔ∏è Supprimer toutes les photos
                    </button>
                </div>
                
                <div id="delete-all-photos-url" data-url="{% url 'administration:delete_all_photos' logement.id %}"></div>
                <ul id="photo-list" class="list-unstyled">
                    {% for photo in logement.photos.all %}
                        <li class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 photo-item" data-photo-id="{{ photo.id }}" data-photo-order="{{ photo.order }}">
                            <div class="d-flex align-items-center">
                                <picture>
                                    <source srcset="{{ photo.image_webp.url }}" type="image/webp">
                                    <img src="{{ photo.image_webp.url }}" style="max-height: 80px;" class="mr-3" alt="{{ photo.room.name }}">
                                </picture>
                                <div>
                                    <span class="badge badge-secondary">üì∏ {{ photo.room.name|default:"G√©n√©ral" }}</span>
                                    <small class="d-block text-muted">#{{ photo.order }}</small>
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                <!-- Room Selector -->
                                <select name="room_id" class="form-control form-control-sm mr-2 room-select" data-photo-id="{{ photo.id }}">
                                    <option value="">{% trans "G√©n√©ral" %}</option>
                                    {% for room in rooms %}
                                        <option value="{{ room.id }}" {% if photo.room.id == room.id %}selected{% endif %}>{{ room.name }}</option>
                                    {% endfor %}
                                </select>

                                <!-- Reorder Buttons -->
                                <button type="button" class="btn btn-sm btn-light mx-1 move-photo" data-direction="up">‚¨ÜÔ∏è</button>
                                <button type="button" class="btn btn-sm btn-light mx-1 move-photo" data-direction="down">‚¨áÔ∏è</button>

                                <!-- Delete Button -->
                                <button type="button" class="btn btn-sm btn-danger delete-photo ml-2">üóëÔ∏è</button>

                                <button type="button" class="btn btn-sm btn-warning rotate-photo ml-2" data-photo-id="{{ photo.id }}">üîÑ</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>

                <div id="move-photo-url" data-url="{% url 'administration:move_photo' photo_id=1 direction='UP' %}"></div>
                <div id="change-photo-room-url" data-url="{% url 'administration:change_photo_room' photo_id=1 %}"></div>
                <div id="delete-photo-url" data-url="{% url 'administration:delete_photo' photo_id=1 %}"></div>
                <div id="rotate-photo-url" data-url="{% url 'administration:rotate_photo' photo_id=1 %}"></div>

                <form action="{% url 'administration:upload_photos' logement.id %}" method="post" enctype="multipart/form-data" class="mt-4">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="room" class="font-weight-bold" style="font-size: 1rem;">
                            {% trans "Associer √† une pi√®ce" %}
                        </label>
                        <select name="room_id" id="room" class="form-control form-control-lg">
                            <option value="">{% trans "G√©n√©ral" %}</option>
                            {% for room in rooms %}
                                <option value="{{ room.id }}">{{ room.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="photos">{% trans "S√©lectionner des photos" %}</label>
                        <input type="file" name="photo" multiple required class="form-control-file" id="photos">
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-info btn-lg">üì• {% trans "Ajouter des photos" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>const csrfToken = "{{ csrf_token }}";</script>
<script src="{% static 'administration/js/admin.js' %}"></script>
{% endblock %}
