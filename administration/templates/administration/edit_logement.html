{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'administration/css/edit_logement.css' %}">
{% endblock %}

{% block content %}
<div class="admin-logement-edit">
    <div class="form-box">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
            <h2 class="mb-2">{{ logement.name }}</h2>
            <a href="{% url 'logement:view_logement' logement.id %}" target="_blank" class="btn btn-outline-primary btn-sm">
                üîç {% trans "Voir le logement" %}
            </a>
        </div>

        <!-- === Logement Edit Form === -->
        <form method="post" class="logement-form">
            {% csrf_token %}
        
            {% if form.errors %}
                <div class="alert alert-danger mt-3">
                    <ul class="mb-0">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        
            <div class="row">
                <div class="col-md-6">
                    <h5 class="section-title">üìå Informations g√©n√©rales</h5>
                    <div class="form-field">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.statut.id_for_label }}">{{ form.statut.label }}</label>
                        {{ form.statut|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.owner.id_for_label }}">{{ form.owner.label }}</label>
                        {{ form.owner|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <div class="admin-checkboxes">
                            {% for checkbox in form.admins %}
                                <div class="checkbox-wrapper">
                                    {{ checkbox }}  <!-- Renders the checkbox -->
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="{{ form.type.id_for_label }}">{{ form.type.label }}</label>
                        {{ form.type|add_class:"form-input" }}
                      </div>
                    <div class="form-field">
                        <label for="{{ form.adresse.id_for_label }}">{{ form.adresse.label }}</label>
                        {{ form.adresse|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.ville.id_for_label }}">{{ form.ville.label }}</label>
                        {{ form.ville|add_class:"form-select" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.map_link.id_for_label }}">{{ form.map_link.label }}</label>
                        {{ form.map_link|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description|add_class:"form-textarea" }}
                    </div>

                    <hr class="my-4">

                    <h5 class="section-title">üåê Plateformes en ligne</h5>
                    <div class="form-field">
                    <label for="{{ form.airbnb_link.id_for_label }}">{{ form.airbnb_link.label }}</label>
                    {{ form.airbnb_link|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                    <label for="{{ form.airbnb_calendar_link.id_for_label }}">{{ form.airbnb_calendar_link.label }}</label>
                    {{ form.airbnb_calendar_link|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                    <label for="{{ form.booking_link.id_for_label }}">{{ form.booking_link.label }}</label>
                    {{ form.booking_link|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                    <label for="{{ form.booking_calendar_link.id_for_label }}">{{ form.booking_calendar_link.label }}</label>
                    {{ form.booking_calendar_link|add_class:"form-input" }}
                    </div>

                    <hr class="my-4">
                            
                    <h5 class="section-title">üõèÔ∏è Capacit√© et pi√®ces</h5>
                    <div class="form-field">
                        <label for="{{ form.max_traveler.id_for_label }}">{{ form.max_traveler.label }}</label>
                        {{ form.max_traveler|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.nominal_traveler.id_for_label }}">{{ form.nominal_traveler.label }}</label>
                        {{ form.nominal_traveler|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.superficie.id_for_label }}">{{ form.superficie.label }}</label>
                        {{ form.superficie|add_class:"form-input" }}
                        <span class="text-muted">m¬≤</span>
                    </div>                    
                    <div class="form-field">
                        <label for="{{ form.bathrooms.id_for_label }}">{{ form.bathrooms.label }}</label>
                        {{ form.bathrooms|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.bedrooms.id_for_label }}">{{ form.bedrooms.label }}</label>
                        {{ form.bedrooms|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.beds.id_for_label }}">{{ form.beds.label }}</label>
                        {{ form.beds|add_class:"form-input" }}
                    </div>
                    <div class="form-field checkbox-field">
                        <input type="checkbox" id="{{ form.smoking.id_for_label }}" name="{{ form.smoking.name }}" {{ form.smoking.value|yesno:"checked," }}>
                        <label for="{{ form.smoking.id_for_label }}">{{ form.smoking.label }}</label>
                    </div>
                      
                    <div class="form-field checkbox-field">
                        <input type="checkbox" id="{{ form.animals.id_for_label }}" name="{{ form.animals.name }}" {{ form.animals.value|yesno:"checked," }}>
                        <label for="{{ form.animals.id_for_label }}">{{ form.animals.label }}</label>
                    </div>
                </div>
        
                <div class="col-md-6">
                    <h5 class="section-title">üí∞ Tarification</h5>
                    <div class="form-field with-symbol">
                        <label for="{{ form.price.id_for_label }}">{{ form.price.label }}</label>
                        <div class="input-symbol">
                            {{ form.price|add_class:"form-input" }}
                            <span>‚Ç¨</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.fee_per_extra_traveler.id_for_label }}">{{ form.fee_per_extra_traveler.label }}</label>
                        <div class="input-symbol">
                            {{ form.fee_per_extra_traveler|add_class:"form-input" }}
                            <span>‚Ç¨</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.cleaning_fee.id_for_label }}">{{ form.cleaning_fee.label }}</label>
                        <div class="input-symbol">
                            {{ form.cleaning_fee|add_class:"form-input" }}
                            <span>‚Ç¨</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.caution.id_for_label }}">{{ form.caution.label }}</label>
                        <div class="input-symbol">
                            {{ form.caution|add_class:"form-input" }}
                            <span>‚Ç¨</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.refund_charge.id_for_label }}">{{ form.refund_charge.label }}</label>
                        <div class="input-symbol">
                            {{ form.refund_charge|add_class:"form-input" }}
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.tax.id_for_label }}">{{ form.tax.label }}</label>
                        <div class="input-symbol">
                            {{ form.tax|add_class:"form-input" }}
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-field with-symbol">
                        <label for="{{ form.tax_max.id_for_label }}">{{ form.tax_max.label }}</label>
                        <div class="input-symbol">
                            {{ form.tax_max|add_class:"form-input" }}
                            <span>‚Ç¨</span>
                        </div>
                    </div>

                    <hr class="my-4">
        
                    <h5 class="section-title">‚è±Ô∏è P√©riodes et horaires</h5>
                    <div class="form-field">
                        <label for="{{ form.cancelation_period.id_for_label }}">{{ form.cancelation_period.label }}</label>
                        {{ form.cancelation_period|add_class:"form-input" }}
                        <span class="text-muted">jour(s)</span>
                    </div>
                    <div class="form-field">
                        <label for="{{ form.ready_period.id_for_label }}">{{ form.ready_period.label }}</label>
                        {{ form.ready_period|add_class:"form-input" }}
                        <span class="text-muted">jour(s)</span>
                    </div>
                    <div class="form-field">
                        <label for="{{ form.entrance_hour_min.id_for_label }}">{{ form.entrance_hour_min.label }}</label>
                        {{ form.entrance_hour_min|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.entrance_hour_max.id_for_label }}">{{ form.entrance_hour_max.label }}</label>
                        {{ form.entrance_hour_max|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.leaving_hour.id_for_label }}">{{ form.leaving_hour.label }}</label>
                        {{ form.leaving_hour|add_class:"form-input" }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.max_days.id_for_label }}">{{ form.max_days.label }}</label>
                        {{ form.max_days|add_class:"form-input" }}
                        <span class="text-muted">jour(s)</span>
                    </div>
                    <div class="form-field">
                        <label for="{{ form.availablity_period.id_for_label }}">{{ form.availablity_period.label }}</label>
                        {{ form.availablity_period|add_class:"form-input" }}
                        <span class="text-muted">mois</span>
                    </div>
                </div>
            </div>
        
            <div class="form-actions text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg px-4">üíæ Enregistrer les modifications</button>
            </div>
        </form>        

        <!-- === Tabs === -->
        <ul class="nav nav-tabs" id="logementTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="rooms-tab" data-toggle="tab" href="#rooms" role="tab">üìÅ {% trans "Pi√®ces" %}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="photos-tab" data-toggle="tab" href="#photos" role="tab">üñºÔ∏è {% trans "Photos" %}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="equipment-tab" data-toggle="tab" href="#equipment" role="tab">
                    üß∞ {% trans "√âquipements" %}
                </a>
            </li>
        </ul>

        <div class="tab-content" id="logementTabsContent">
            <!-- === Rooms Tab === -->
            <div class="tab-pane fade show active pt-4" id="rooms" role="tabpanel">
                <ul class="list-unstyled mb-3">
                    {% for room in rooms %}
                        <li class="d-flex justify-content-between align-items-center py-1">
                            <span>üè∑Ô∏è {{ room.name }}</span>
                            <form method="post" action="{% url 'administration:delete_room' room.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('{% trans 'Supprimer cette pi√®ce ?' %}')">üóëÔ∏è</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>

                <form method="post" action="{% url 'administration:add_room' logement.id %}" class="form-inline">
                    {% csrf_token %}
                    <input type="text" name="name" placeholder="{% trans 'Nom de la pi√®ce' %}" class="form-control mr-2" required>
                    <button type="submit" class="btn btn-success">‚ûï {% trans 'Ajouter' %}</button>
                </form>
            </div>

            <!-- === Photos Tab === -->
            <div class="tab-pane fade pt-4" id="photos" role="tabpanel">
                <div class="text-right mb-3">
                    <button id="delete-all-photos" class="btn btn-danger btn-sm">
                        üóëÔ∏è Supprimer toutes les photos
                    </button>
                </div>
                
                <div id="delete-all-photos-url" data-url="{% url 'administration:delete_all_photos' logement.id %}"></div>
                <ul id="photo-list" class="list-unstyled">
                    {% for photo in photos %}
                        <li class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 photo-item" data-photo-id="{{ photo.id }}" data-photo-order="{{ photo.order }}">
                            <div class="d-flex align-items-center">
                                <picture>
                                    <source srcset="{{ photo.image_webp.url }}" type="image/webp">
                                    <img src="{{ photo.image_webp.url }}" style="max-height: 80px;" class="mr-3" alt="{{ photo.room.name }}">
                                </picture>
                                <div>
                                    <span class="badge badge-secondary">üì∏ {{ photo.room.name|default:"G√©n√©ral" }}</span>
                                    <small class="d-block text-muted">#{{ photo.order }}</small>
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                <!-- Room Selector -->
                                <select name="room_id" class="form-control form-control-sm mr-2 room-select" data-photo-id="{{ photo.id }}">
                                    <option value="">{% trans "G√©n√©ral" %}</option>
                                    {% for room in rooms %}
                                        <option value="{{ room.id }}" {% if photo.room.id == room.id %}selected{% endif %}>{{ room.name }}</option>
                                    {% endfor %}
                                </select>

                                <!-- Reorder Buttons -->
                                <button type="button" class="btn btn-sm btn-light mx-1 move-photo" data-direction="up">‚¨ÜÔ∏è</button>
                                <button type="button" class="btn btn-sm btn-light mx-1 move-photo" data-direction="down">‚¨áÔ∏è</button>

                                <!-- Delete Button -->
                                <button type="button" class="btn btn-sm btn-danger delete-photo ml-2">üóëÔ∏è</button>

                                <button type="button" class="btn btn-sm btn-warning rotate-photo ml-2" data-photo-id="{{ photo.id }}">üîÑ</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>

                <div id="move-photo-url" data-url="{% url 'administration:move_photo' photo_id=1 direction='UP' %}"></div>
                <div id="change-photo-room-url" data-url="{% url 'administration:change_photo_room' photo_id=1 %}"></div>
                <div id="delete-photo-url" data-url="{% url 'administration:delete_photo' photo_id=1 %}"></div>
                <div id="rotate-photo-url" data-url="{% url 'administration:rotate_photo' photo_id=1 %}"></div>

                <form action="{% url 'administration:upload_photos' logement.id %}" method="post" enctype="multipart/form-data" class="mt-4">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="room" class="font-weight-bold" style="font-size: 1rem;">
                            {% trans "Associer √† une pi√®ce" %}
                        </label>
                        <select name="room_id" id="room" class="form-control form-control-lg">
                            <option value="">{% trans "G√©n√©ral" %}</option>
                            {% for room in rooms %}
                                <option value="{{ room.id }}">{{ room.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="photos">{% trans "S√©lectionner des photos" %}</label>
                        <input type="file" name="photo" multiple required class="form-control-file" id="photos">
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-info btn-lg">üì• {% trans "Ajouter des photos" %}</button>
                    </div>
                </form>
            </div>

            <!-- === Equipment Tab === -->
            <div class="tab-pane fade pt-4" id="equipment" role="tabpanel">
                <form method="post" action="{% url 'administration:update_equipment' logement.id %}">
                    {% csrf_token %}
                    <div class="equipment-grid">
                        {% for equip in all_equipment %}
                            <label class="equip-card">
                                <input type="checkbox" name="equipment" value="{{ equip.id }}"
                                    {% if equip.id in selected_equipment_ids %}checked{% endif %}>
                                {% if equip.icon %}
                                    <i class="{{ equip.icon }}"></i>
                                {% endif %}
                                {{ equip.name }}
                            </label>
                        {% endfor %}
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary mt-4 px-4 py-2">üíæ {% trans "Enregistrer les √©quipements" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>const csrfToken = "{{ csrf_token }}";</script>
    <script src="{% static 'administration/js/admin.js' %}"></script>
{% endblock %}
