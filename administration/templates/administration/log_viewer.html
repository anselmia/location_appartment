{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block extrahead %}
    <link rel="stylesheet"
          href="{% static 'administration/css/log_viewer.css' %}">
{% endblock %}
{% block content %}
    <div class="container mt-4">
        <h2 class="mb-3">📝 Logs système</h2>
        <form method="get" class="mb-3 d-flex flex-wrap align-items-end gap-3">
            <div class="flex-grow-1" style="min-width: 200px;">
                <label for="level" class="form-label">Filtrer par niveau :</label>
                <select name="level"
                        id="level"
                        onchange="this.form.submit()"
                        class="form-control">
                    <option value="">Tous</option>
                    {% for level in levels %}
                        <option value="{{ level }}"
                                {% if selected_level == level %}selected{% endif %}>{{ level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-grow-1" style="min-width: 250px;">
                <label for="logger" class="form-label">Filtrer par logger :</label>
                <select name="logger"
                        id="logger"
                        onchange="this.form.submit()"
                        class="form-control">
                    <option value="">Tous</option>
                    {% for logger in loggers %}
                        <option value="{{ logger }}"
                                {% if selected_logger == logger %}selected{% endif %}>{{ logger }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-grow-1" style="min-width: 250px;">
                <label for="query" class="form-label">Contient :</label>
                <input type="text"
                       name="query"
                       id="query"
                       class="form-control"
                       placeholder="Texte à chercher…"
                       value="{{ query|default_if_none:'' }}"
                       oninput="this.form.submit()">
            </div>
        </form>
        <div class="log-table">
            <table class="table table-sm table-hover table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Horodatage</th>
                        <th scope="col">Niveau</th>
                        <th scope="col">Logger</th>
                        <th scope="col">Localisation</th>
                        <th scope="col">Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                        <tr class="log-{{ log.level|lower }}">
                            <td>{{ log.timestamp }}</td>
                            <td>
                                <strong>{{ log.level }}</strong>
                            </td>
                            <td>{{ log.logger }}</td>
                            <td>
                                <code>{{ log.location }}</code>
                            </td>
                            <td style="white-space: pre-wrap;">{{ log.message }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5">Aucun log trouvé.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            {% if paginator and page_obj %}
                <nav aria-label="Pagination">
                    <ul class="pagination-list mb-0">
                        {# First page #}
                        {% if page_obj.number > 1 %}
                            <li class="page-item">
                                <a href="?page=1&level={{ selected_level|default:'None' }}&logger={% if selected_logger and selected_logger != '' and selected_logger != 'Tous' %}{{ selected_logger }}{% else %}None{% endif %}&query={{ query }}">««</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span>««</span>
                            </li>
                        {% endif %}
                        {# Previous page #}
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a href="?page={{ page_obj.previous_page_number }}&level={{ selected_level|default:'None' }}&logger={% if selected_logger and selected_logger != '' and selected_logger != 'Tous' %}{{ selected_logger }}{% else %}None{% endif %}&query={{ query }}">«</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span>«</span>
                            </li>
                        {% endif %}
                        {# Page numbers #}
                        {% for num in paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span>{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a href="?page={{ num }}&level={{ selected_level|default:'None' }}&logger={% if selected_logger and selected_logger != '' and selected_logger != 'Tous' %}{{ selected_logger }}{% else %}None{% endif %}&query={{ query }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {# Next page #}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a href="?page={{ page_obj.next_page_number }}&level={{ selected_level|default:'None' }}&logger={% if selected_logger and selected_logger != '' and selected_logger != 'Tous' %}{{ selected_logger }}{% else %}None{% endif %}&query={{ query }}">»</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span>»</span>
                            </li>
                        {% endif %}
                        {# Last page #}
                        {% if page_obj.number < paginator.num_pages %}
                            <li class="page-item">
                                <a href="?page={{ paginator.num_pages }}&level={{ selected_level|default:'None' }}&logger={% if selected_logger and selected_logger != '' and selected_logger != 'Tous' %}{{ selected_logger }}{% else %}None{% endif %}&query={{ query }}">»»</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span>»»</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
{% endblock content %}
