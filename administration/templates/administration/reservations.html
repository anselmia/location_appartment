{% extends 'base.html' %}
{% load static %}
{% load extra_tags %}

{% block extrahead %}
  {{ block.super }}  
  <link rel="stylesheet" href="{% static 'administration/css/reservation.css' %}">
{% endblock %}

{% block content %}
<div class="container-reservation py-4">
    <div class="reservation-filters mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h1 class="reservation-title mb-2">Réservations</h1>
    
            <!-- Status filters -->
            <div class="status-filters d-none d-md-flex gap-2">
                <button class="btn btn-outline-secondary btn-filter" onclick="filterStatus('all')">Tout</button>
                <button class="btn btn-outline-success btn-filter" onclick="filterStatus('confirmee')">Confirmée</button>
                <button class="btn btn-outline-info btn-filter" onclick="filterStatus('terminee')">Terminée</button>
                <button class="btn btn-outline-danger btn-filter" onclick="filterStatus('annulee')">Annulée</button>
            </div>
    
            <!-- Mobile Status Filter -->
            <select class="form-select d-md-none" onchange="filterStatus(this.value)">
                <option value="all">Tout</option>
                <option value="confirmee">Confirmée</option>
                <option value="terminee">Terminée</option>
                <option value="annulee">Annulée</option>
            </select>
        </div>
    </div>

    <!-- Filter form -->
    <form method="get" class="filter-form row g-2 align-items-center flex-wrap mb-3">
        <div class="col-auto">
            <label for="yearFilter" class="col-form-label">Année</label>
        </div>
        <div class="col-auto">
            <select id="yearFilter" name="year" class="form-select">
                <option value="">Toutes</option>
                {% for y in available_years %}
                    <option value="{{ y }}" {% if current_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-auto">
            <label for="monthFilter" class="col-form-label">Mois</label>
        </div>
        <div class="col-auto">
            <select id="monthFilter" name="month" class="form-select">
                <option value="">Tous</option>
                {% for m in available_months %}
                    <option value="{{ m }}" {% if current_month == m|stringformat:"s" %}selected{% endif %}>
                        {{ m|get_month_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <div class="search-wrapper mb-4">
        <input type="text" id="searchInput" class="form-control search-input" placeholder="Rechercher un voyageur...">
    </div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered text-center align-middle" id="reservationTable">
            <thead class="table-dark">
                <tr>
                    <th>Logement</th>
                    <th>Statut</th>
                    <th>Voyageur</th>
                    <th>Arrivée</th>
                    <th>Départ</th>
                    <th>Réservée le</th>
                    <th>Invité(s)</th>
                    <th>Prix</th>
                    <th>Taxes</th>
                    <th>Détail</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations %}
                <tr data-status="{{ r.statut|lower }}">
                    <td class="logement-cell align-middle" data-label="Logement">
                        <div class="logement-info d-flex align-items-center gap-2">
                            {% if r.logement.photos.all %}
                                <img src="{{ r.logement.photos.all.0.image.url }}"
                                     alt="{{ r.logement.name }}"
                                     title="{{ r.logement.name }}"
                                     class="logement-thumbnail">
                            {% else %}
                                <div title="{{ r.logement.name }}"
                                     class="logement-thumbnail placeholder-img"></div>
                            {% endif %}
                            <span class="logement-name d-none d-md-inline">{{ r.logement.name }}</span>
                        </div>
                    </td>
                    <td data-label="Statut">
                        <span class="badge status-badge {{ r.statut|lower }}">{{ r.get_statut_display|title }}</span>
                    </td>
                    <td data-label="Voyageur">{{ r.user.name }} {{ r.user.last_name }}</td>
                    <td data-label="Arrivée">{{ r.start|date:"d M Y" }}</td>
                    <td data-label="Départ">{{ r.end|date:"d M Y" }}</td>
                    <td data-label="Réservée le">{{ r.date_reservation|date:"d M Y H:i" }}</td>
                    <td data-label="Invité(s)">{{ r.guest }}</td>
                    <td data-label="Prix">{{ r.price|floatformat:2 }} €</td>
                    <td data-label="Taxes">{{ r.tax|floatformat:2 }} €</td>
                    <td data-label="Détail">
                        <a href="{% url 'administration:reservation_detail' r.id %}" class="btn btn-sm btn-primary">
                            Voir
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'administration/js/reservation.js' %}"></script>
{% endblock %}
