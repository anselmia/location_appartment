{% extends "base.html" %}
{% load static %}
{% load extra_tags %}
{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'administration/css/revenu.css' %}">
{% endblock extrahead %}
{% block content %}
  <div class="container mt-5" id="revenue-page">
    <h2 class="text-center mb-5 fw-bold">Tableau de Revenu</h2>
    <!-- Filters Section -->
    <div class="card shadow-sm mb-4">
      <div class="card-body row g-3 align-items-center">
        <!-- Logement Filter -->
        <form method="get" class="row g-3 align-items-end justify-content-center">
          <div class="col-md-4">
            <label for="logement-select" class="form-label fw-semibold text-muted">Logement :</label>
            <select id="logement-select"
                    name="logement_id"
                    class="form-select"
                    onchange="this.form.submit()">
              <option value="" {% if not logement_id %}selected{% endif %}>Tous les logements</option>
              {% for loge in logements %}
                <option value="{{ loge.id }}"
                        {% if loge.id|stringformat:"s" == logement_id|stringformat:"s" %}selected{% endif %}>
                  {{ loge.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="year" class="form-label fw-semibold text-muted">Ann√©e :</label>
            <select name="year"
                    id="year"
                    class="form-select"
                    onchange="this.form.submit()">
              {% for y in available_years %}
                <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="month" class="form-label fw-semibold text-muted">Mois :</label>
            <select name="month"
                    id="month"
                    class="form-select"
                    onchange="this.form.submit()">
              {% for m in available_months %}
                <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
    </div>
    <!-- Economic Summary -->
    <div class="card shadow-lg mb-5">
      <div class="card-body">
        <h4 class="fw-semibold mb-4">R√©sum√© √âconomique</h4>
        <div class="row text-center">
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">Revenu Brut</h6>
              <p class="text-primary display-6 fw-bold" id="total-revenue">‚Ç¨0.00</p>
            </div>
          </div>
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">Taxes Collect√©es</h6>
              <p class="display-6 fw-bold" id="total-taxes">‚Ç¨0.00</p>
            </div>
          </div>
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">Remboursements</h6>
              <p class="text-danger display-6 fw-bold" id="total-refunds">‚Ç¨0.00</p>
            </div>
          </div>
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">Frais Plateforme</h6>
              <p class="display-6 fw-bold" id="total-plateform">‚Ç¨0.00</p>
            </div>
          </div>
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">Frais Paiement</h6>
              <p class="display-6 fw-bold" id="total-payment">‚Ç¨0.00</p>
            </div>
          </div>
          <div class="col-md-4 mb-3 md-0">
            <div class="p-3 border rounded bg-light">
              <h6 class="text-muted mb-2">B√©n√©fice Net</h6>
              <p class="text-success display-6 fw-bold" id="net-profit">‚Ç¨0.00</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Error Message -->
    <div id="economy-error" class="alert alert-danger d-none"></div>
    <!-- Chart Section -->
    <div class="card shadow-lg mb-5">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-semibold">üìÖ Graphique des Revenus Annuels {{ selected_year }}</h5>
          <small class="text-muted">Vue empil√©e : revenu net, frais, remboursements</small>
        </div>
        <canvas id="economy-chart" height="100"></canvas>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
  const logementId = {{ logement_id|default:"null" }};
  const labels = {{ chart_labels|safe }};
  const totalRevenuNet = {{ revenue_net_data|safe }};
  const totalRevenuBrut = {{ revenue_brut_data|safe }};
  const admintotalRevenu = {{ admin_revenue_data|safe }};
  const totalRefunds = {{ refunds_data|safe }};
  const platformEarnings = {{ platform_fee_data|safe }};
  const paymentFees = {{ payment_fee_data|safe }};
  const taxes = {{ tax_data|safe }};
  const csrfToken = "{{ csrf_token }}";
  </script>
  <script src="{% static 'administration/js/revenu.js' %}"></script>
{% endblock extra_js %}
