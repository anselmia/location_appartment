{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}

{% block content %}
    <div class="container">
        <!-- Image Gallery -->
        <div class="row justify-content-center mt-4">
            <div class="col-md-12">
                <div class="image-gallery">
                    {% if logement.photos.count > 0 %}
                        <div class="gallery-left">
                            <picture>
                                <source srcset="{{ logement.photos.all.0.image_webp.url }}" type="image/webp">
                                <img src="{{ logement.photos.all.0.image_webp.url }}" alt="Photo principale" loading="lazy">
                            </picture>
                        </div>
                        <div class="gallery-right">
                        {% for photo in logement.photos.all|slice:"1:5" %}
                            <div class="small-photo">
                                <picture>
                                    <source srcset="{{ photo.image_webp.url }}" type="image/webp">
                                    <img src="{{ photo.image_webp.url }}" alt="Photo {{ forloop.counter }}" loading="lazy">
                                </picture>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <p>Aucune photo disponible.</p>
                    {% endif %}
                </div>               
            </div>
        </div>

        <form method="post" id="reservation-form">
            {% csrf_token %}

            <div class="row gx-4 gy-4 align-items-stretch">        
                <!-- Left Column: Reservation Form -->
                <div class="col-md-6 d-flex">
                    <div class="card shadow-lg flex-fill w-100">
                        <div class="card-body">
                            <h2 class="text-center mb-4">{{ logement_data.name }}</h2>
                
                            {% if form.errors %}
                                <div class="alert alert-danger">
                                <ul>
                                    {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                                </div>
                            {% endif %}
                
                            <h3 class="text-center mb-4">Informations sur le séjour</h3>

                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label for="id_guest">Voyageurs</label>
                                {{ form.guest|add_class:"auto-width" }}
                            </div>

                            <div class="calendar-box mt-4">
                                <div id="calendar_inline"></div>
                                <div class="legend">
                                    <div class="legend-item"><span class="dot booked"></span> Réservé</div>
                                    <div class="legend-item"><span class="dot today"></span> Aujourd’hui</div>
                                    <div class="legend-item"><span class="dot free"></span> Disponible</div>
                                </div>
                            </div>

                            <input type="hidden"
                                id="id_start"
                                name="start"
                                value="{{ form.start.value|default:'' }}">

                            <input type="hidden"
                                id="id_end"
                                name="end"
                                value="{{ form.end.value|default:'' }}">
                
                            <input type="hidden" id="reservation-id" name="reservation_id" value="{{ reservation.id }}">
                            <input type="hidden" id="reservation-price" name="reservation_price" value="0">
                            <input type="hidden" id="reservation-tax" name="reservation_tax" value="0">
                        </div>
                    </div>
                </div>
        
                <!-- Right Column: Summary + Submit -->
                <div id="booking-detail" class="col-md-6 d-flex">
                    <div class="card shadow-lg flex-fill w-100">
                        <div class="card-body">
                            <h4 class="text-center mb-4">Résumé de la Réservation</h4>
                
                            <p><strong>Arrivée :</strong> <span id="start-date">{{ form.start.value }}</span></p>
                            <p><strong>Départ :</strong> <span id="end-date">{{ form.end.value }}</span></p>
                            <p><strong>Voyageurs :</strong> <span id="guest-count">{{ form.guest.value }}</span></p>
                
                            <hr>
                
                            <div id="details">
                                <!-- Dynamic pricing breakdown -->
                            </div>
                
                            <div>
                                <strong>Prix Total : <span id="final-price">0</span> €</strong>
                            </div>
                
                            <hr>
                
                            <h4 class="text-center mb-4">Informations du Voyageur</h4>
                            <p><strong>Nom :</strong> <span>{{ user.last_name }}</span></p>
                            <p><strong>Prénom :</strong> <span>{{ user.name }}</span></p>
                            <p><strong>Email :</strong> <span>{{ user.email }}</span></p>
                            <p><strong>Téléphone :</strong> <span>{{ user.phone }}</span></p>
                
                            <div class="form-group text-center mt-4">
                                <button id="submit-booking" type="submit" class="btn btn-primary btn-lg">Procéder au Paiement</button>
                            </div>
                        </div>
                    </div>
                </div>
        
            </div>
        </form>  
    </div>

    <!-- Modal to display all photos -->
    <div id="imageModal" class="image-modal">
        <span id="closeModal" class="close-btn">&times;</span>
        <span id="modalPrev" class="modal-arrow modal-arrow-left">&#10094;</span>
        <img id="modalImage" class="modal-content" src="">
        <span id="modalNext" class="modal-arrow modal-arrow-right">&#10095;</span>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    const logement_js = {{ logement_data|safe }};
    const logementId = {{ logement.id }};  
    const csrfToken = "{{ csrf_token }}";
    const stripe_public_key = "{{ STRIPE_PUBLIC_KEY|escapejs }}";
    const reservationId = {% if reservation_id %}{{ reservation_id|escapejs }}{% else %}null{% endif %};
    const reservedDatesStart = {{ reserved_dates_start_json|safe }};
    const reservedDatesEnd = {{ reserved_dates_end_json|safe }};
    const today = new Date().toISOString().slice(0, 10);
    const allPhotoUrls = {{ photo_urls|safe }};
    const periodLimit = {{ logement.availablity_period }};  
</script>
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'logement/js/image-galery.js' %}"></script>
<script src="{% static 'logement/js/booking.js' %}"></script>
<script src="{% static 'logement/js/calendar.js' %}"></script>
{% endblock %}
