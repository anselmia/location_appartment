{% extends "base.html" %}
{% load static %}
{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'logement/css/search_result.css' %}">
  <link rel="stylesheet"
        href="{% static 'logement/css/logements_grid.css' %}">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
{% endblock %}
{% block content %}
  <div class="search-page">
    <!-- HERO -->
    <div class="hero-banner"
         style="background-image: url('{% static 'logement/img/search.jpg' %}')">
      <div class="overlay">
        <h1>Trouvez votre logement idÃ©al</h1>
        <p>RÃ©servez en toute sÃ©rÃ©nitÃ© avec notre conciergerie</p>
      </div>
    </div>
    <!-- SEARCH BAR -->
    <form method="get"
          action="{% url 'logement:logement_search' %}"
          class="compact-search-bar">
      <div class="search-input destination">
        <label>Destination</label>
        <input type="text"
               name="destination"
               placeholder="Rechercher une destination"
               value="{{ request.GET.destination }}"
               list="cities"
               id="destination-input"
               autocomplete="off">
        <datalist id="cities"></datalist>
      </div>
      <div class="search-input dates">
        <label>DurÃ©e</label>
        <input type="text"
               id="datepicker"
               class="date-input"
               placeholder="Ajouter des dates"
               value="{{ request.GET.start_date|date:'j F' }} â€“ {{ request.GET.end_date|date:'j F' }}"
               readonly>
        <input type="hidden"
               name="start_date"
               id="start_date"
               value="{{ request.GET.start_date }}">
        <input type="hidden"
               name="end_date"
               id="end_date"
               value="{{ request.GET.end_date }}">
        <input type="hidden"
               name="flexibility"
               id="flexibility"
               value="{{ request.GET.flexibility|default:0 }}">
      </div>
      <div class="search-input guests">
        <label>Adulte(s)</label>
        <input type="number"
               name="guest_adult"
               placeholder="Nombre d'adultes"
               value="{{ request.GET.guest_adult|default:1 }}"
               min="1">
      </div>
      <div class="search-input guests">
        <label>Enfant(s)</label>
        <input type="number"
               name="guest_minor"
               placeholder="Nombre de mineurs"
               value="{{ request.GET.guest_minor|default:0 }}"
               min="0">
      </div>
      <!-- âœ… Optional: keep filters if this bar is reused while filters are active -->
      {% for eq in selected_equipment_ids %}<input type="hidden" name="equipments" value="{{ eq }}">{% endfor %}
      {% if request.GET.bedrooms %}<input type="hidden" name="bedrooms" value="{{ request.GET.bedrooms }}">{% endif %}
      {% if request.GET.bathrooms %}<input type="hidden" name="bathrooms" value="{{ request.GET.bathrooms }}">{% endif %}
      {% if request.GET.is_smoking_allowed %}<input type="hidden" name="is_smoking_allowed" value="1">{% endif %}
      {% if request.GET.is_pets_allowed %}<input type="hidden" name="is_pets_allowed" value="1">{% endif %}
      {% if selected_type %}<input type="hidden" name="type" value="{{ selected_type }}">{% endif %}
      <button type="submit" class="search-btn">
        <i class="fas fa-search"></i>
      </button>
    </form>
    <!-- FILTERS -->
    <button type="button"
            class="btn btn-secondary d-md-none toggle-filters-btn"
            onclick="toggleFilters()">ðŸ”½ Filtres</button>
    <div class="search-layout-container">
      <aside class="search-filters d-md-block" id="filter-panel">
        <form method="get" action="{% url 'logement:logement_search' %}">
          <!-- Type de logement -->
          <div class="filter-group">
            <h3>Type de logement</h3>
            <select name="type">
              <option value="">Tous les types</option>
              {% for value, label in types %}
                <option value="{{ value }}"
                        {% if selected_type == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <br>
          <!-- Ã‰quipements -->
          <div class="filter-group">
            <h3>Ã‰quipements</h3>
            <div class="filter-options scrollable-box">
              {% for equipment in equipments %}
                <label>
                  <input type="checkbox"
                         name="equipments"
                         value="{{ equipment.id }}"
                         {% if equipment.id|stringformat:"s" in selected_equipment_ids %}checked{% endif %}>
                  {{ equipment.name }}
                </label>
              {% endfor %}
            </div>
          </div>
          <br>
          <!-- Autres options -->
          <div class="filter-group">
            <h3>Autorisations</h3>
            <label>
              <input type="checkbox"
                     name="is_smoking_allowed"
                     value="1"
                     {% if request.GET.is_smoking_allowed %}checked{% endif %}>
              Fumeur
            </label>
            <label>
              <input type="checkbox"
                     name="is_pets_allowed"
                     value="1"
                     {% if request.GET.is_pets_allowed %}checked{% endif %}>
              Animaux acceptÃ©s
            </label>
          </div>
          <br>
          <!-- Chambres -->
          <div class="filter-group">
            <h3>Chambres</h3>
            <div class="numeric-filters">
              {% for n in number_range %}
                <input type="radio"
                       id="bedroom-{{ n }}"
                       name="bedrooms"
                       value="{{ n }}"
                       {% if request.GET.bedrooms == n|stringformat:"s" %}checked{% endif %}>
                <label for="bedroom-{{ n }}">{{ n }}</label>
              {% endfor %}
            </div>
          </div>
          <br>
          <!-- Salles de bain -->
          <div class="filter-group">
            <h3>Salles de bain</h3>
            <div class="numeric-filters">
              {% for n in number_range %}
                <input type="radio"
                       id="bathroom-{{ n }}"
                       name="bathrooms"
                       value="{{ n }}"
                       {% if request.GET.bathrooms == n|stringformat:"s" %}checked{% endif %}>
                <label for="bathroom-{{ n }}">{{ n }}</label>
              {% endfor %}
            </div>
          </div>
          <!-- Hidden fields -->
          <input type="hidden"
                 name="destination"
                 value="{{ request.GET.destination }}">
          <input type="hidden" name="start_date" value="{{ request.GET.start_date }}">
          <input type="hidden" name="end_date" value="{{ request.GET.end_date }}">
          <input type="hidden" name="guest_adult" value="{{ request.GET.guest_adult }}">
          <input type="hidden" name="guest_minor" value="{{ request.GET.guest_minor }}">
          <input type="hidden"
                 name="flexibility"
                 value="{{ request.GET.flexibility }}">
          <div class="filter-button-wrapper">
            <button class="filter-button" type="submit">Filtrer</button>
          </div>
          <div class="filter-reset-wrapper">
            <a href="{% url 'logement:logement_search' %}" class="reset-button">RÃ©initialiser</a>
          </div>
        </form>
      </aside>
      <section class="logements-results">
        <div class="view-switcher">
          <a href="?{{ request.GET.urlencode|add:"&view=grid" }}"
             class="view-btn {% if request.GET.view == 'grid' or not request.GET.view %}active{% endif %}"><i class="fas fa-th"></i> Grille</a>
          <a href="?{{ request.GET.urlencode|add:"&view=list" }}"
             class="view-btn {% if request.GET.view == 'list' %}active{% endif %}"><i class="fas fa-list"></i> Liste</a>
          <a href="?{{ request.GET.urlencode|add:"&view=map" }}"
             class="view-btn {% if request.GET.view == 'map' %}active{% endif %}"><i class="fas fa-map"></i> Plan</a>
        </div>
        {% if request.GET.view == "list" %}
          <div class="logements-list">{% include 'logement/partials/logement_list_view.html' %}</div>
        {% elif request.GET.view == "map" %}
          <div class="logements-map">{% include 'logement/partials/logement_map_view.html' %}</div>
        {% else %}
          <div class="logements-grid">{% include 'logement/partials/logement_grid_view.html' %}</div>
        {% endif %}
        {% if request.GET.view == "list" or  request.GET.view == "grid" %}
          <div class="pagination">
            <ul class="pagination-list">
              {% if page_obj.has_previous %}
                <li>
                  <a href="?destination={{ destination }}&guest_adult={{ guest_adult }}&guest_minor={{ guest_minor }}&page={{ page_obj.previous_page_number }}">Â«</a>
                </li>
              {% else %}
                <li class="disabled">Â«</li>
              {% endif %}
              {% for i in page_obj.paginator.page_range %}
                {% if page_obj.number == i %}
                  <li class="active">{{ i }}</li>
                {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                  <li>
                    <a href="?destination={{ destination }}&guest_adult={{ guest_adult }}&guest_minor={{ guest_minor }}}&page={{ i }}">{{ i }}</a>
                  </li>
                {% endif %}
              {% endfor %}
              {% if page_obj.has_next %}
                <li>
                  <a href="?destination={{ destination }}&guest_adult={{ guest_adult }}&guest_minor={{ guest_minor }}&page={{ page_obj.next_page_number }}">Â»</a>
                </li>
              {% else %}
                <li class="disabled">Â»</li>
              {% endif %}
            </ul>
          </div>
        {% endif %}
      </section>
    </div>
  {% endblock %}
  {% block extra_js %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Marker Cluster CSS -->
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="{% static 'logement/js/search_result.js' %}"></script>
  {% endblock %}
