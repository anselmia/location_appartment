{% extends "base.html" %}
{% load static %}
{% block extrahead %}
  <link rel="stylesheet" href="{% static 'logement/css/discounts.css' %}">
{% endblock %}

{% block content %}
<div class="discounts-container">
  <!-- Logement Selector -->
  <form method="get" class="logement-select-form mb-4" onchange="this.submit()">
    <label for="logement-select" class="form-label fw-semibold me-2">Choisir un logement :</label>
    <select name="logement_id" id="logement-select" class="form-select d-inline w-auto">
      {% for l in all_logements %}
        <option value="{{ l.id }}" {% if logement.id == l.id %}selected{% endif %}>{{ l.name }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- Table des r√©ductions existantes -->
  <div class="table-responsive mb-5 shadow-sm rounded">
    <table class="table table-hover table-bordered align-middle text-center">
      <thead class="table-header text-white" style="background-color: var(--primary-color);">
        <tr>
          <th>Type</th>
          <th>Nom</th>
          <th>Valeur (%)</th>
          <th>Nuits min</th>
          <th>Nuits exactes</th>
          <th>Jours min avant</th>
          <th>Jours max avant</th>
          <th>Date d√©but</th>
          <th>Date fin</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in discounts %}
          <tr>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="discount_id" value="{{ d.id }}">
              <input type="hidden" name="discount_type" value="{{ d.discount_type.id }}">

              <td><input type="text" class="form-control" value="{{ d.discount_type.name }}" disabled></td>
              <td><input type="text" name="name" class="form-control" value="{{ d.name }}"></td>
              <td><input type="number" step="0.1" name="value" class="form-control" value="{{ d.value|stringformat:'0.2f'|cut:',' }}"></td>
              <td><input type="number" name="min_nights" class="form-control" value="{{ d.min_nights }}"></td>
              <td><input type="number" name="exact_nights" class="form-control" value="{{ d.exact_nights }}"></td>
              <td><input type="number" name="days_before_min" class="form-control" value="{{ d.days_before_min }}"></td>
              <td><input type="number" name="days_before_max" class="form-control" value="{{ d.days_before_max }}"></td>
              <td><input type="date" name="start_date" class="form-control" value="{{ d.start_date|date:'Y-m-d' }}"></td>
              <td><input type="date" name="end_date" class="form-control" value="{{ d.end_date|date:'Y-m-d' }}"></td>
              <td>
                <div class="d-flex gap-2 justify-content-center">
                  <button name="action" value="update" class="btn btn-sm btn-primary">üìÇ</button>
                  <button name="action" value="delete" class="btn btn-sm btn-outline-danger" onclick="return confirm('Supprimer cette r√©duction ?');">üóëÔ∏è</button>
                </div>
              </td>
            </form>
          </tr>
        {% empty %}
          <tr><td colspan="10" class="text-muted text-center">Aucune r√©duction enregistr√©e.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Formulaire d'ajout -->
  <div class="discount-form bg-white shadow-sm rounded">
    <h4 class="mb-3 fw-semibold">Ajouter une nouvelle r√©duction</h4>
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="logement_id" value="{{ logement.id }}">

      <div class="row g-3">
        <!-- Always visible -->
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label">Type de r√©duction</label>
          <select name="discount_type" id="discount-type-select" class="form-select" required>
            {% for dt in discount_types %}
              <option value="{{ dt.id }}"
                      data-min-nights="{{ dt.requires_min_nights|yesno:'1,0' }}"
                      data-days-before="{{ dt.requires_days_before|yesno:'1,0' }}"
                      data-date-range="{{ dt.requires_date_range|yesno:'1,0' }}"
                      {% if form.discount_type.value == dt.id %}selected{% endif %}>{{ dt.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label">Nom interne</label>
          {{ form.name }}
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label">Valeur (%)</label>
          {{ form.value }}
        </div>

        <!-- Conditional fields -->
        <div class="col-6 col-md-4 min-nights-field"><label class="form-label">Nuits min</label>{{ form.min_nights }}</div>
        <div class="col-6 col-md-4 exact-nights-field"><label class="form-label">Nuits exactes</label>{{ form.exact_nights }}</div>
        <div class="col-6 col-md-4 days-before-min-field"><label class="form-label">Jours min avant</label>{{ form.days_before_min }}</div>
        <div class="col-6 col-md-4 days-before-max-field"><label class="form-label">Jours max avant</label>{{ form.days_before_max }}</div>
        <div class="col-6 col-md-4 start-date-field"><label class="form-label">Date d√©but</label>{{ form.start_date }}</div>
        <div class="col-6 col-md-4 end-date-field"><label class="form-label">Date fin</label>{{ form.end_date }}</div>
      </div>

      <div class="mt-4">
        <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>const csrfToken = "{{ csrf_token }}";</script>
<script src="{% static 'logement/js/discounts.js' %}"></script>
{% endblock %}
