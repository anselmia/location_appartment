{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}
{% block title %}R√©ductions pour {{ logement.name }} | {{ entreprise.name }}{% endblock %}
{% block meta_description %}
  G√©rez les r√©ductions disponibles pour le logement {{ logement.name }} sur {{ entreprise.name }}. Ajoutez, modifiez ou supprimez des offres facilement.
{% endblock %}
{% block extrahead %}
  <link rel="stylesheet" href="{% static 'logement/css/discounts.css' %}">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
{% endblock %}
{% block content %}
  <div class="container py-4">
    <h1 class="fw-bold mb-2">üè∑Ô∏è R√©ductions</h1>
    <p class="text-muted mb-4">
      G√©rez les r√©ductions disponibles pour ce logement. Ajoutez, modifiez ou supprimez les offres facilement.
    </p>
    <!-- Logement Selector -->
    <form method="get"
          class="logement-select-form mb-4"
          onchange="this.submit()">
      <label for="logement-select" class="form-label fw-semibold me-2">Choisir un logement :</label>
      <select name="logement_id"
              id="logement-select"
              class="form-select d-inline w-auto">
        {% for l in all_logements %}
          <option value="{{ l.id }}" {% if logement.id == l.id %}selected{% endif %}>{{ l.name }}</option>
        {% endfor %}
      </select>
    </form>
    <!-- Table des r√©ductions -->
    <div class="table-responsive mb-5">
      <table class="table table-hover table-striped align-middle text-center">
        <thead class="text-white" style="background-color: var(--primary-color);">
          <tr>
            <th>Type</th>
            <th>Nom</th>
            <th>%</th>
            <th>Min nuits</th>
            <th>Nuits exactes</th>
            <th>Min jours avant</th>
            <th>Max jours avant</th>
            <th>D√©but</th>
            <th>Fin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for d in discounts %}
            <tr>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="discount_id" value="{{ d.id }}">
                <input type="hidden" name="discount_type" value="{{ d.discount_type.id }}">
                <td>
                  <input type="text"
                         class="form-control form-control-sm"
                         value="{{ d.discount_type.name }}"
                         disabled>
                </td>
                <td>
                  <input type="text"
                         name="name"
                         class="form-control form-control-sm"
                         value="{{ d.name }}">
                </td>
                <td>
                  <input type="number"
                         step="0.1"
                         name="value"
                         class="form-control form-control-sm"
                         value="{{ d.value|stringformat:'0.2f'|cut:',' }}">
                </td>
                <td>
                  <input type="number"
                         name="min_nights"
                         class="form-control form-control-sm"
                         value="{{ d.min_nights }}">
                </td>
                <td>
                  <input type="number"
                         name="exact_nights"
                         class="form-control form-control-sm"
                         value="{{ d.exact_nights }}">
                </td>
                <td>
                  <input type="number"
                         name="days_before_min"
                         class="form-control form-control-sm"
                         value="{{ d.days_before_min }}">
                </td>
                <td>
                  <input type="number"
                         name="days_before_max"
                         class="form-control form-control-sm"
                         value="{{ d.days_before_max }}">
                </td>
                <td>
                  <input type="date"
                         name="start_date"
                         class="form-control form-control-sm"
                         value="{{ d.start_date|date:'Y-m-d' }}">
                </td>
                <td>
                  <input type="date"
                         name="end_date"
                         class="form-control form-control-sm"
                         value="{{ d.end_date|date:'Y-m-d' }}">
                </td>
                <td class="d-flex gap-1 justify-content-center">
                  <button name="action"
                          value="update"
                          class="btn btn-sm btn-primary"
                          title="Sauvegarder">
                    <i class="bi bi-save"></i>
                  </button>
                  <button name="action"
                          value="delete"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Supprimer cette r√©duction ?');"
                          title="Supprimer">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </form>
            </tr>
          {% empty %}
            <tr>
              <td colspan="10" class="text-muted text-center">Aucune r√©duction enregistr√©e.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="discount-card d-md-none">
        {% for d in discounts %}
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="fw-bold">
                {{ d.name }} <span class="text-muted small">({{ d.discount_type.name }})</span>
              </h6>
              <p class="mb-1">üí∞ {{ d.value }} %</p>
              <p class="mb-1">üõèÔ∏è {{ d.min_nights }} nuits min</p>
              <p class="mb-1">üìÖ {{ d.start_date }} ‚Üí {{ d.end_date }}</p>
              <form method="post" class="mt-2 d-flex gap-2 justify-content-end">
                {% csrf_token %}
                <input type="hidden" name="discount_id" value="{{ d.id }}">
                <input type="hidden" name="discount_type" value="{{ d.discount_type.id }}">
                <button name="action" value="update" class="btn btn-sm btn-primary">
                  <i class="bi bi-save"></i>
                </button>
                <button name="action"
                        value="delete"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Supprimer ?');">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </div>
        {% empty %}
          <p class="text-muted text-center">Aucune r√©duction enregistr√©e.</p>
        {% endfor %}
      </div>
    </div>
    <!-- Ajout d'une nouvelle r√©duction -->
    <div class="card border-0 shadow-sm p-4 bg-light">
      <div class="card-header bg-white border-bottom mb-3">
        <h5 class="mb-0">‚ûï Nouvelle r√©duction</h5>
      </div>
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="logement_id" value="{{ logement.id }}">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
          <div class="col">
            <label class="form-label">Type de r√©duction</label>
            <select name="discount_type"
                    id="discount-type-select"
                    class="form-select form-select-sm"
                    required>
              {% for dt in discount_types %}
                <option value="{{ dt.id }}"
                        data-min-nights="{{ dt.requires_min_nights|yesno:'1,0' }}"
                        data-days-before="{{ dt.requires_days_before|yesno:'1,0' }}"
                        data-date-range="{{ dt.requires_date_range|yesno:'1,0' }}"
                        {% if form.discount_type.value == dt.id %}selected{% endif %}>{{ dt.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col">
            <label class="form-label">Nom interne</label>
            {{ form.name|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col">
            <label class="form-label">Valeur (%)</label>
            {{ form.value|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col min-nights-field">
            <label class="form-label">Nuits min</label>
            {{ form.min_nights|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col exact-nights-field">
            <label class="form-label">Nuits exactes</label>
            {{ form.exact_nights|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col days-before-min-field">
            <label class="form-label">Jours min avant</label>
            {{ form.days_before_min|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col days-before-max-field">
            <label class="form-label">Jours max avant</label>
            {{ form.days_before_max|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col start-date-field">
            <label class="form-label">Date d√©but</label>
            {{ form.start_date|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col end-date-field">
            <label class="form-label">Date fin</label>
            {{ form.end_date|add_class:"form-control form-control-sm" }}
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-success">Ajouter</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script>const csrfToken = "{{ csrf_token }}";</script>
  <script src="{% static 'logement/js/discounts.js' %}"></script>
{% endblock %}
