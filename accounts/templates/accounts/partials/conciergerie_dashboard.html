{% load static %}
<div class="card shadow rounded-4 border-0 mb-4">
    <div class="card-header text-white rounded-top-4">
        <h5 class="mb-0">üè† Conciergerie</h5>
    </div>
    <div class="card-body">
        {% if not conciergerie %}
            <p class="text-muted mb-3">Aucune conciergerie n‚Äôest enregistr√©e pour le moment.</p>
            <a href="{% url 'conciergerie:create_conciergerie' %}"
               class="btn btn-primary">‚ûï Cr√©er ma conciergerie</a>
        {% else %}
            <form method="post"
                  action="{% url 'conciergerie:delete_conciergerie' conciergerie.id %}"
                  onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer votre conciergerie ? Cette action est irr√©versible.');"
                  class="position-absolute top-0 end-0 mt-2 me-2">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-outline-danger btn-circle btn-sm shadow-sm"
                        title="Supprimer ma conciergerie"
                        style="width:2rem;
                               height:2rem;
                               display:flex;
                               align-items:center;
                               justify-content:center">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
            <div class="mb-3">
                <div class="row gy-3">
                    <div class="col-md-6">
                        <strong>Nom :</strong>
                        <div class="text-muted small">{{ conciergerie.name }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>Email :</strong>
                        <div class="text-muted small">{{ conciergerie.email }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>T√©l√©phone :</strong>
                        <div class="text-muted small">{{ conciergerie.telephone }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>Adresse :</strong>
                        <div class="text-muted small">
                            {{ conciergerie.adresse }}, {{ conciergerie.code_postal }} {{ conciergerie.ville.name }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <strong>Forme juridique :</strong>
                        <div class="text-muted small">{{ conciergerie.forme_juridique|default:"-" }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>SIRET :</strong>
                        <div class="text-muted small">{{ conciergerie.siret|default:"-" }}</div>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted">Cr√©√©e le {{ conciergerie.date_creation|date:"d/m/Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Valid√©e :</strong>
                        {% if conciergerie.validated %}
                            <span class="badge-status validee">‚úÖ Valid√©e</span>
                        {% else %}
                            <span class="badge-status en_attente">‚è≥ En attente</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <a href="{% url 'conciergerie:update_conciergerie' %}"
                   class="btn btn-primary">‚úèÔ∏è Modifier ma conciergerie</a>
            </div>
            {# --- Administered Logements List --- #}
            <hr class="my-4">
            <h6 class="fw-semibold mb-3">üè° Logements administr√©s</h6>
            {% if logement_administrated and logement_administrated|length > 0 %}
                <div class="row g-3">
                    {% for logement in logement_administrated %}
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-1">{{ logement.name }}</h6>
                                    <div class="text-muted small mb-2">{{ logement.adresse }}, {{ logement.ville.name }}</div>
                                    <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                                        <span class="badge bg-info text-dark">#{{ logement.code }}</span>
                                        <a href="{% url 'logement:view_logement' logement.id %}"
                                           class="btn btn-outline-primary btn-sm">üëÅÔ∏è Voir</a>
                                        <button class="btn btn-outline-danger btn-sm stop-managing-btn"
                                                data-logement-id="{{ logement.id }}">üö´ Arr√™ter la gestion</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Aucun logement administr√© actuellement.</p>
            {% endif %}
            {# --- Pending Conciergerie Requests --- #}
            <hr class="my-4">
            <h6 class="fw-semibold mb-3">‚è≥ Demandes d'administration en attente</h6>
            {% if pending_requests and pending_requests|length > 0 %}
                <div class="list-group mb-2">
                    {% for req in pending_requests %}
                        <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="fw-semibold">{{ req.logement.name }}</span>
                                <span class="text-muted small ms-2">({{ req.logement.adresse }}, {{ req.logement.ville.name }})</span>
                                <span class="badge bg-warning text-dark ms-2">En attente</span>
                                <a href="{% url 'logement:view_logement' req.logement.id %}"
                                   class="btn btn-outline-primary btn-sm ms-2">üëÅÔ∏è Voir</a>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm accept-request-btn"
                                        data-request-id="{{ req.id }}">‚úÖ Accepter</button>
                                <button class="btn btn-outline-danger btn-sm refuse-request-btn"
                                        data-request-id="{{ req.id }}">‚ùå Refuser</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Aucune demande en attente.</p>
            {% endif %}
            <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
            <script>
            $(function() {
                // Stop managing logement
                $('.stop-managing-btn').on('click', function() {
                    const logementId = $(this).data('logement-id');
                    if (confirm('Confirmez-vous l\'arr√™t de gestion de ce logement ?')) {
                        $.ajax({
                            url: '{% url "logement:stop_managing_logement" %}',
                            method: 'POST',
                            data: {
                                logement_id: logementId,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(data) {
                                location.reload();
                            },
                            error: function(xhr) {
                                alert('Erreur lors de l\'arr√™t de gestion.');
                            }
                        });
                    }
                });
                // Accept/Refuse conciergerie request
                $('.accept-request-btn, .refuse-request-btn').on('click', function() {
                    const requestId = $(this).data('request-id');
                    const action = $(this).hasClass('accept-request-btn') ? 'accept' : 'refuse';
                    $.ajax({
                        url: '{% url "conciergerie:handle_request" %}',
                        method: 'POST',
                        data: {
                            request_id: requestId,
                            action: action,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function(data) {
                            location.reload();
                        },
                        error: function(xhr) {
                            alert('Erreur lors du traitement de la demande.');
                        }
                    });
                });
            });
            </script>
        {% endif %}
    </div>
</div>
