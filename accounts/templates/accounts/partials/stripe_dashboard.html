{% load extra_tags %}
{% load static %}
<div class="card shadow rounded-4 border-0 mb-4">
  <div class="card-header text-white rounded-top-4">
    <h5 class="mb-0">💼 Compte Stripe</h5>
  </div>
  <div class="card-body">
    {% if not stripe_account %}
      <div class="text-center py-4">
        <p class="text-muted mb-3">Aucun compte Stripe connecté pour le moment.</p>
        <a href="{% url 'accounts:create_stripe_account' %}"
           class="btn btn-primary">➕ Créer un compte Stripe</a>
      </div>
    {% else %}
      <!-- Stripe Account Info -->
      <div class="row gy-3 mb-3">
        <div class="col-12 col-md-6">
          <div class="p-3 rounded-3 bg-light h-100">
            <div class="mb-2">
              <span class="fw-bold">ID Stripe :</span>
              <span class="text-muted small ms-2">{{ stripe_account.id|default:"—" }}</span>
            </div>
            <div class="mb-2">
              <span class="fw-bold">Pays :</span>
              <span class="text-muted small ms-2">{{ stripe_account.country|default:"—" }}</span>
            </div>
            <div class="mb-2">
              <span class="fw-bold">Statut :</span>
              {% if stripe_account.details_submitted %}
                <span class="badge bg-success ms-2">✅ Validé</span>
              {% else %}
                <span class="badge bg-warning text-dark ms-2">❌ Incomplet</span>
              {% endif %}
            </div>
            <div>
              <span class="fw-bold">État :</span>
              <span class="small text-muted ms-2">
                {% if stripe_account.requirements.currently_due %}
                  {{ stripe_account.requirements.currently_due|length }} informations manquantes
                {% else %}
                  Aucune information manquante
                {% endif %}
              </span>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          {% if stripe_account.requirements.currently_due %}
            <div class="alert alert-warning mb-0">
              <div class="fw-bold mb-1">⚠️ Informations manquantes :</div>
              <ul class="mb-0 ps-3">
                {% for field in stripe_account.requirements.currently_due %}
                  <li>
                    <code>{{ field }}</code>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="alert alert-success mb-0">
              <span class="fw-bold">Votre compte est complet.</span>
            </div>
          {% endif %}
        </div>
      </div>
      <!-- Stripe Balances & Payouts -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100 bg-light">
            <div class="card-body text-center">
              <div class="fw-bold text-muted small mb-1">Solde disponible</div>
              <div class="display-6">
                {% if stripe_balance and stripe_balance.available %}
                  {{ stripe_balance.available.0.amount|floatformat:2|default:"0.00" }} {{ stripe_balance.available.0.currency|upper|default:"" }}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100 bg-light">
            <div class="card-body text-center">
              <div class="fw-bold text-muted small mb-1">Solde à venir</div>
              <div class="display-6">
                {% if stripe_balance and stripe_balance.pending %}
                  {{ stripe_balance.pending.0.amount|floatformat:2|default:"0.00" }} {{ stripe_balance.pending.0.currency|upper|default:"" }}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100 bg-light">
            <div class="card-body text-center">
              <div class="fw-bold text-muted small mb-1">Dernier virement</div>
              <div class="display-6">
                {% if stripe_payouts and stripe_payouts.data and stripe_payouts.data.0 %}
                  {{ stripe_payouts.data.0.amount|floatformat:2|default:"0.00" }} {{ stripe_payouts.data.0.currency|upper|default:"" }}
                  <div class="small text-muted mt-1">{{ stripe_payouts.data.0.arrival_date|date:"d/m/Y" }}</div>
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Stripe Transactions Table -->
      <div class="mb-4">
        <h6 class="mb-2">Dernières transactions Stripe</h6>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Montant</th>
                <th>Devise</th>
                <th>ID</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in stripe_transactions %}
                <tr>
                  <td>{{ tx.created|date:"d/m/Y H:i" }}</td>
                  <td>{{ tx.type|default:"—" }}</td>
                  <td>
                    {% if tx.amount %}
                      {{ tx.amount|floatformat:2 }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ tx.currency|upper|default:"—" }}</td>
                  <td>
                    <code>{{ tx.id|default:"—" }}</code>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-muted text-center">Aucune transaction trouvée.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Actions -->
      <div class="d-flex flex-wrap gap-2 mt-3">
        <a href="{% url 'accounts:update_stripe_account' %}"
           class="btn btn-primary">📝 Mettre à jour</a>
        {% if dashboard_link %}
          <a href="{{ dashboard_link }}"
             target="_blank"
             class="btn btn-outline-secondary">🔗 Ouvrir le Dashboard Stripe</a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
