{% extends 'base.html' %}
{% load static %}
{% block title %}Messagerie â€“ {{ entreprise.name }}{% endblock %}
{% block meta_description %}
    Consultez et Ã©changez vos messages avec lâ€™Ã©quipe ou votre hÃ´te via la messagerie sÃ©curisÃ©e de {{ entreprise.name }}. Communication simple et historique de vos conversations pour vos rÃ©servations Ã  Nice et sur la CÃ´te dâ€™Azur.
{% endblock %}
{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'accounts/css/message.css' %}">
{% endblock extrahead %}
{% block content %}
    <div class="container-fluid mt-4 messaging-interface">
        <div class="d-flex messaging-layout sidebar-open" id="messaging-layout">
            <!-- Sidebar: Conversations List -->
            <!-- Main: Messages -->
            <div class="messaging-main flex-grow-1">
                <div class="alert alert-info mt-4">SÃ©lectionnez une conversation pour afficher les messages.</div>
            </div>
            <h1 class="mb-4">Messagerie</h1>
            <div class="messaging-sidebar flex-shrink-0">
                {% if reservations_to_start %}
                    <div class="p-3 border-top bg-light">
                        <form method="post" action="{% url 'accounts:start_conversation' %}">
                            {% csrf_token %}
                            <div class="mb-2">
                                <select name="reservation_id" class="form-select" required>
                                    <option value="" disabled selected>Choisir une rÃ©servation</option>
                                    {% for res in reservations_to_start %}
                                        <option value="{{ res.id }}">{{ res.code }} - {{ res.logement.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">âž• DÃ©marrer une conversation</button>
                        </form>
                    </div>
                {% endif %}
                <div class="card h-100">
                    <div class="card-header">
                        <strong>ðŸ’¬ Conversations</strong>
                    </div>
                    <ul class="list-group list-group-flush overflow-auto"
                        style="max-height: 70vh">
                        {% for conv in conversations %}
                            <a href="{% url 'accounts:messages_conversation' conv.id %}"
                               class="list-group-item list-group-item-action d-flex align-items-center">
                                <!-- Logement thumbnail -->
                                {% with conv.reservation.logement.photos.first as photo %}
                                    {% if photo %}
                                        <img src="{{ photo.image.url }}"
                                             alt="photo"
                                             class="rounded me-2"
                                             style="width: 40px;
                                                    height: 40px;
                                                    object-fit: cover">
                                    {% else %}
                                        <div class="rounded bg-secondary text-white d-flex justify-content-center align-items-center me-2"
                                             style="width: 40px;
                                                    height: 40px">
                                            <i class="fas fa-home"></i>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                                <!-- Conversation details -->
                                <div class="flex-grow-1 ml-3">
                                    <strong>{{ conv.reservation }}</strong> - {{ conv.reservation.logement.name }}
                                    <br>
                                    <small class="text-muted">
                                        {% if conv.last_message %}{{ conv.last_message.timestamp|date:"d/m H:i" }}{% endif %}
                                    </small>
                                </div>
                                {% if conv.unread_count %}<span class="badge bg-danger ms-2">{{ conv.unread_count }}</span>{% endif %}
                            </a>
                        {% empty %}
                            <li class="list-group-item text-muted">Aucune conversation</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
